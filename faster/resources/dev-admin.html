<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dev Admin Dashboard</title>

    <!-- Tailwind CSS + DaisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>

    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Sentry Error Tracking -->
    <script
      src="https://js.sentry-cdn.com/adeace5dba8b6da452a690af61684344.min.js"
      crossorigin="anonymous"
    ></script>

    <style>
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      [x-cloak] {
        display: none !important;
      }
    </style>
  </head>

  <body class="bg-base-100 min-h-screen" x-data="devAdmin" x-init="init()">
    <!-- Toast Container -->
    <div class="toast toast-end z-50" x-show="toast.show" x-transition>
      <div class="alert" :class="toast.class">
        <i :data-lucide="toast.icon" class="w-5 h-5"></i>
        <span x-text="toast.message"></span>
      </div>
    </div>

    <!-- Loading Screen -->
    <div
      x-show="currentView === 'loading'"
      class="flex items-center justify-center min-h-screen"
      x-cloak
    >
      <div class="text-center">
        <div class="loading loading-spinner loading-lg text-primary"></div>
        <p class="mt-4 text-base-content" x-text="loadingMessage"></p>
      </div>
    </div>

    <!-- Authentication Container -->
    <div
      x-show="currentView === 'auth'"
      class="min-h-screen bg-base-200 flex items-center justify-center p-4"
      x-cloak
    >
      <div class="card w-full max-w-md bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-center justify-center mb-6">
            <i data-lucide="shield-check" class="w-6 h-6 text-primary"></i>
            Dev Admin Login
          </h2>

          <!-- OAuth Login Buttons -->
          <div class="space-y-3 mb-4">
            <button
              @click="signInWithOAuth('google')"
              :disabled="authLoading"
              class="btn btn-outline btn-block"
            >
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                <path
                  fill="currentColor"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="currentColor"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="currentColor"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="currentColor"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Continue with Google
            </button>

            <button
              @click="signInWithOAuth('github')"
              :disabled="authLoading"
              class="btn btn-outline btn-block"
            >
              <i data-lucide="github" class="w-5 h-5"></i>
              Continue with GitHub
            </button>
          </div>

          <div class="divider">OR</div>

          <!-- Email/Password Form -->
          <form @submit.prevent="handleEmailSubmit" class="space-y-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text">Email</span>
              </label>
              <input
                x-model="auth.email"
                type="email"
                placeholder="Enter your email"
                class="input input-bordered"
                :class="{ 'input-error': auth.errors.email }"
                required
                autocomplete="email"
              />
              <div class="label" x-show="auth.errors.email">
                <span
                  class="label-text-alt text-error"
                  x-text="auth.errors.email"
                ></span>
              </div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Password</span>
              </label>
              <input
                x-model="auth.password"
                type="password"
                placeholder="Enter your password"
                class="input input-bordered"
                :class="{ 'input-error': auth.errors.password }"
                required
                autocomplete="current-password"
              />
              <div class="label" x-show="auth.errors.password">
                <span
                  class="label-text-alt text-error"
                  x-text="auth.errors.password"
                ></span>
              </div>
            </div>

            <button
              type="submit"
              :disabled="authLoading"
              class="btn btn-primary btn-block"
              :class="{ 'loading': authLoading }"
            >
              <template x-if="!authLoading">
                <i
                  :data-lucide="auth.isSignUp ? 'user-plus' : 'log-in'"
                  class="w-5 h-5"
                ></i>
              </template>
              <span x-text="auth.isSignUp ? 'Sign Up' : 'Sign In'"></span>
            </button>
          </form>

          <!-- Sign Up Toggle -->
          <div class="text-center mt-4">
            <button @click="toggleSignUp" class="link link-primary text-sm">
              <span
                x-text="auth.isSignUp ? 'Already have an account? Sign in' : 'Need an account? Sign up'"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Application Container -->
    <div x-show="currentView === 'app'" class="min-h-screen" x-cloak>
      <!-- Navigation Header -->
      <div class="navbar bg-base-100 shadow-lg">
        <div class="navbar-start">
          <h1 class="text-xl font-bold text-primary">
            <i data-lucide="code" class="w-6 h-6 inline mr-2"></i>
            Dev Admin
          </h1>
        </div>

        <div class="navbar-end">
          <!-- Theme Toggler -->
          <label class="swap swap-rotate mr-2">
            <input type="checkbox" @change="toggleTheme" x-model="darkMode" />
            <i data-lucide="sun" class="swap-on w-5 h-5"></i>
            <i data-lucide="moon" class="swap-off w-5 h-5"></i>
          </label>

          <div class="dropdown dropdown-end">
            <div
              tabindex="0"
              role="button"
              class="btn btn-ghost btn-circle avatar placeholder"
            >
              <div class="w-10 rounded-full bg-neutral text-neutral-content">
                <img
                  x-show="user && user.user_metadata && user.user_metadata.avatar_url"
                  :src="user && user.user_metadata ? user.user_metadata.avatar_url : ''"
                  class="rounded-full"
                  alt="User Avatar"
                />
                <span
                  x-show="!user || !user.user_metadata || !user.user_metadata.avatar_url"
                  class="text-xl"
                  x-text="getUserInitials()"
                ></span>
              </div>
            </div>
            <ul
              tabindex="0"
              class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52"
            >
              <li>
                <a @click.prevent="loadPage('dashboard')" href="#">
                  <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                  Dashboard
                </a>
              </li>
              <li>
                <a @click.prevent="loadPage('profile')" href="#">
                  <i data-lucide="user" class="w-4 h-4"></i>
                  Profile
                </a>
              </li>
              <li>
                <hr class="my-2" />
              </li>
              <li>
                <a @click.prevent="signOut" href="#" class="text-error">
                  <i data-lucide="log-out" class="w-4 h-4"></i>
                  Logout
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="container mx-auto p-4">
        <div
          id="main-content"
          class="fade-in"
          hx-get="/auth/dashboard"
          hx-trigger="load once"
          hx-target="this"
          hx-swap="innerHTML"
        >
          <!-- Default Dashboard Content -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Welcome Card -->
            <div
              class="card bg-gradient-to-r from-primary to-secondary text-primary-content col-span-full"
            >
              <div class="card-body">
                <h2 class="card-title">
                  <i data-lucide="hand-heart" class="w-6 h-6"></i>
                  Welcome back!
                </h2>
                <p>Your development admin dashboard is ready to go.</p>
              </div>
            </div>

            <!-- Stats Cards -->
            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-base-content/60">Total Projects</p>
                    <p class="text-3xl font-bold">12</p>
                  </div>
                  <i data-lucide="folder" class="w-10 h-10 text-primary"></i>
                </div>
              </div>
            </div>

            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-base-content/60">Active Tasks</p>
                    <p class="text-3xl font-bold">8</p>
                  </div>
                  <i
                    data-lucide="check-circle"
                    class="w-10 h-10 text-success"
                  ></i>
                </div>
              </div>
            </div>

            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-base-content/60">Issues</p>
                    <p class="text-3xl font-bold">3</p>
                  </div>
                  <i
                    data-lucide="alert-circle"
                    class="w-10 h-10 text-warning"
                  ></i>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="card bg-base-100 shadow-xl col-span-full lg:col-span-2">
              <div class="card-body">
                <h3 class="card-title">
                  <i data-lucide="activity" class="w-5 h-5"></i>
                  Recent Activity
                </h3>
                <div class="space-y-4 mt-4">
                  <div class="flex items-center space-x-3">
                    <div class="avatar placeholder">
                      <div
                        class="w-10 h-10 bg-primary text-primary-content rounded-full"
                      >
                        <i data-lucide="git-commit" class="w-5 h-5"></i>
                      </div>
                    </div>
                    <div class="flex-1">
                      <p class="font-medium">
                        New commit pushed to main branch
                      </p>
                      <p class="text-sm text-base-content/60">2 hours ago</p>
                    </div>
                  </div>
                  <div class="flex items-center space-x-3">
                    <div class="avatar placeholder">
                      <div
                        class="w-10 h-10 bg-success text-success-content rounded-full"
                      >
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                      </div>
                    </div>
                    <div class="flex-1">
                      <p class="font-medium">
                        Task completed: Update documentation
                      </p>
                      <p class="text-sm text-base-content/60">4 hours ago</p>
                    </div>
                  </div>
                  <div class="flex items-center space-x-3">
                    <div class="avatar placeholder">
                      <div
                        class="w-10 h-10 bg-warning text-warning-content rounded-full"
                      >
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                      </div>
                    </div>
                    <div class="flex-1">
                      <p class="font-medium">
                        New issue reported: Login timeout
                      </p>
                      <p class="text-sm text-base-content/60">6 hours ago</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="card bg-base-100 shadow-xl">
              <div class="card-body">
                <h3 class="card-title">
                  <i data-lucide="zap" class="w-5 h-5"></i>
                  Quick Actions
                </h3>
                <div class="space-y-2 mt-4">
                  <button class="btn btn-sm btn-outline btn-block">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    New Project
                  </button>
                  <button class="btn btn-sm btn-outline btn-block">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Deploy
                  </button>
                  <button class="btn btn-sm btn-outline btn-block">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    Settings
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("devAdmin", () => ({
          // 状态管理
          currentView: "loading",
          loadingMessage: "Initializing...",
          configLoaded: false,
          authLoading: false,

          // 配置信息
          config: {
            supabaseUrl: "",
            supabaseKey: "",
            backendUrl: "",
            sentryDsn: "",
            sentryEnvironment: "development",
            sentryEnabled: true
          },

          // 认证状态
          auth: {
            email: "",
            password: "",
            isSignUp: false,
            errors: {}
          },

          // 用户信息
          user: null,
          supabase: null,

          // UI 状态
          darkMode: false,
          toast: {
            show: false,
            message: "",
            class: "",
            icon: "info"
          },

          // 初始化
          async init() {
            console.log("Initializing Dev Admin Dashboard...");

            try {
              this.initTheme();
              await this.$nextTick();
              lucide.createIcons();

              // 开始配置加载循环
              this.startConfigLoading();
            } catch (error) {
              console.error("Failed to initialize:", error);
              this.showToast(
                "Initialization failed: " + error.message,
                "error"
              );
              this.currentView = "auth";
            }
          },

          // 配置加载循环 - 唯一的定时器
          startConfigLoading() {
            this.loadingMessage = "Loading configuration...";

            const configInterval = setInterval(async () => {
              try {
                console.log("Attempting to load configuration...");
                await this.loadConfig();

                if (this.configLoaded) {
                  console.log("Configuration loaded successfully");
                  clearInterval(configInterval);
                  await this.initializeApp();
                }
              } catch (error) {
                console.log(
                  "Config loading failed, retrying...",
                  error.message
                );
                // 继续重试，不中断循环
              }
            }, 2000);
          },

          // 加载配置
          async loadConfig() {
            try {
              const response = await fetch("/dev/settings", {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json"
                }
              });

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              const data = await response.json();

              if (data && data.data) {
                this.config = { ...this.config, ...data.data };
                this.configLoaded = true;
                console.log("Configuration loaded:", this.config);
              } else {
                throw new Error("Invalid configuration response format");
              }
            } catch (error) {
              console.error("Failed to load configuration:", error);
              throw error;
            }
          },

          // 初始化应用
          async initializeApp() {
            console.log("Initializing application with loaded config...");
            this.loadingMessage = "Setting up services...";

            try {
              // 初始化 Sentry
              if (this.config.sentryEnabled && this.config.sentryDsn) {
                this.initSentry();
              }

              // 初始化 Supabase
              if (this.config.supabaseUrl && this.config.supabaseKey) {
                this.initSupabase();
                await this.checkSession();
              } else {
                console.warn("Supabase credentials not available");
                this.showToast(
                  "Supabase credentials not configured",
                  "warning"
                );
                this.currentView = "auth";
              }

              // 设置 HTMX 配置
              this.setupHTMX();
            } catch (error) {
              console.error("App initialization failed:", error);
              this.showToast(
                "Application setup failed: " + error.message,
                "error"
              );
              this.currentView = "auth";
            }
          },

          // 初始化 Supabase
          initSupabase() {
            try {
              this.supabase = supabase.createClient(
                this.config.supabaseUrl,
                this.config.supabaseKey
              );

              // 设置认证状态监听
              this.supabase.auth.onAuthStateChange((event, session) => {
                console.log("Auth state changed:", event);
                this.handleAuthStateChange(event, session);
              });

              console.log("Supabase initialized successfully");
              return true;
            } catch (error) {
              console.error("Supabase initialization failed:", error);
              this.showToast(
                "Supabase setup failed: " + error.message,
                "error"
              );
              return false;
            }
          },

          // 初始化 Sentry
          initSentry() {
            if (!this.config.sentryDsn) {
              console.log("Sentry DSN not configured");
              return;
            }

            try {
              Sentry.init({
                dsn: this.config.sentryDsn,
                environment: this.config.sentryEnvironment,
                tracesSampleRate:
                  this.config.sentryEnvironment === "production" ? 0.1 : 1.0
              });
              console.log("Sentry initialized successfully");
            } catch (error) {
              console.error("Sentry initialization failed:", error);
            }
          },

          // 设置 HTMX
          setupHTMX() {
            // 配置 HTMX 默认行为
            htmx.config.defaultSwapStyle = "innerHTML";
            htmx.config.requestClass = "loading";
            htmx.config.timeout = 10000;

            // 设置默认请求头
            document.body.addEventListener("htmx:configRequest", evt => {
              evt.detail.headers["Content-Type"] = "application/json";
              evt.detail.headers["Accept"] = "application/json";

              // 添加认证头
              if (this.user && this.supabase) {
                this.supabase.auth
                  .getSession()
                  .then(({ data: { session } }) => {
                    if (session) {
                      evt.detail.headers[
                        "Authorization"
                      ] = `Bearer ${session.access_token}`;
                    }
                  });
              }
            });

            // 请求完成后重新创建图标
            document.body.addEventListener("htmx:afterRequest", () => {
              this.$nextTick(() => {
                lucide.createIcons();
              });
            });

            console.log("HTMX configured");
          },

          // 检查会话
          async checkSession() {
            if (!this.supabase) {
              this.currentView = "auth";
              return;
            }

            try {
              console.log("Checking existing session...");
              const {
                data: { session },
                error
              } = await this.supabase.auth.getSession();

              if (error) throw error;

              if (session && session.user) {
                console.log("Active session found:", session.user.email);
                this.user = session.user;
                this.currentView = "app";

                // 通知后端用户登录
                this.notifyBackendLogin();
              } else {
                console.log("No active session found");
                this.currentView = "auth";
              }
            } catch (error) {
              console.error("Session check failed:", error);
              this.showToast("Session check failed: " + error.message, "error");
              this.currentView = "auth";
            }
          },

          // 认证状态变化处理
          handleAuthStateChange(event, session) {
            if (event === "SIGNED_IN" && session && session.user) {
              console.log(
                "User signed in via auth state change:",
                session.user.email
              );
              this.user = session.user;
              this.currentView = "app";
              this.showToast("Login successful!", "success");
              this.notifyBackendLogin();
            } else if (event === "SIGNED_OUT") {
              console.log("User signed out via auth state change");
              this.user = null;
              this.currentView = "auth";
              this.notifyBackendLogout();
            }
          },

          // OAuth 登录
          async signInWithOAuth(provider) {
            if (!this.supabase) {
              this.showToast("Authentication not configured", "warning");
              return;
            }

            console.log(`Attempting ${provider} OAuth login...`);
            this.authLoading = true;

            try {
              const { error } = await this.supabase.auth.signInWithOAuth({
                provider,
                options: { redirectTo: window.location.href }
              });

              if (error) throw error;
            } catch (error) {
              console.error(`${provider} login failed:`, error);
              this.showToast(
                `${provider} login failed: ${error.message}`,
                "error"
              );
            } finally {
              this.authLoading = false;
            }
          },

          // 邮箱登录/注册处理
          async handleEmailSubmit() {
            this.clearAuthErrors();

            // 验证
            if (!this.auth.email) {
              this.auth.errors.email = "Email is required";
              return;
            }
            if (!this.auth.password) {
              this.auth.errors.password = "Password is required";
              return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(this.auth.email)) {
              this.auth.errors.email = "Invalid email format";
              return;
            }

            if (!this.supabase) {
              this.showToast("Authentication not configured", "warning");
              return;
            }

            this.authLoading = true;

            try {
              if (this.auth.isSignUp) {
                await this.signUpWithEmail();
              } else {
                await this.signInWithEmail();
              }
            } finally {
              this.authLoading = false;
            }
          },

          // 邮箱登录
          async signInWithEmail() {
            console.log("Attempting email login...");

            try {
              const {
                data,
                error
              } = await this.supabase.auth.signInWithPassword({
                email: this.auth.email,
                password: this.auth.password
              });

              if (error) throw error;

              console.log("Email login successful:", data.user.email);
              this.user = data.user;
              this.currentView = "app";
              this.showToast("Login successful!", "success");
              this.clearAuthForm();
              this.notifyBackendLogin();
            } catch (error) {
              console.error("Email login failed:", error);
              this.showToast("Login failed: " + error.message, "error");
            }
          },

          // 邮箱注册
          async signUpWithEmail() {
            console.log("Attempting email signup...");

            try {
              const { error } = await this.supabase.auth.signUp({
                email: this.auth.email,
                password: this.auth.password
              });

              if (error) throw error;

              this.showToast(
                "Account created! Please check your email for verification.",
                "success"
              );
              this.clearAuthForm();
            } catch (error) {
              console.error("Email signup failed:", error);
              this.showToast("Sign up failed: " + error.message, "error");
            }
          },

          // 登出
          async signOut() {
            console.log("User signing out...");

            try {
              await this.notifyBackendLogout();

              if (this.supabase) {
                const { error } = await this.supabase.auth.signOut();
                if (error) throw error;
              }

              this.user = null;
              this.currentView = "auth";
              this.showToast("Logged out successfully", "success");
            } catch (error) {
              console.error("Logout failed:", error);
              this.showToast("Logout failed: " + error.message, "error");
            }
          },

          // 页面加载
          loadPage(page) {
            console.log("Loading page:", page);

            const endpoints = {
              dashboard: "/auth/dashboard",
              profile: "/auth/profile"
            };

            const endpoint = endpoints[page];
            if (!endpoint) {
              this.showToast("Page not found: " + page, "error");
              return;
            }

            // 使用 HTMX 加载内容
            htmx
              .ajax("GET", endpoint, {
                target: "#main-content",
                swap: "innerHTML"
              })
              .then(() => {
                console.log("Page loaded successfully:", page);
                this.$nextTick(() => {
                  lucide.createIcons();
                });
              })
              .catch(error => {
                console.error("Failed to load page:", error);
                this.showToast("Failed to load page: " + page, "error");
              });
          },

          // 后端通知
          async notifyBackendLogin() {
            if (!this.config.backendUrl) return;

            try {
              await this.apiCall("/auth/login", "POST");
              console.log("Backend notified of login");
            } catch (error) {
              console.warn("Failed to notify backend of login:", error);
            }
          },

          async notifyBackendLogout() {
            if (!this.config.backendUrl) return;

            try {
              await this.apiCall("/auth/logout", "POST");
              console.log("Backend notified of logout");
            } catch (error) {
              console.warn("Failed to notify backend of logout:", error);
            }
          },

          // API 调用辅助方法
          async apiCall(endpoint, method = "GET", body = null) {
            if (!this.config.backendUrl) {
              throw new Error("Backend URL not configured");
            }

            const headers = {
              "Content-Type": "application/json",
              Accept: "application/json"
            };

            // 添加认证头
            if (this.supabase && this.user) {
              try {
                const {
                  data: { session }
                } = await this.supabase.auth.getSession();
                if (session) {
                  headers["Authorization"] = `Bearer ${session.access_token}`;
                }
              } catch (error) {
                console.warn("Failed to get session for API call:", error);
              }
            }

            const options = {
              method,
              headers
            };

            if (body && method !== "GET") {
              options.body = JSON.stringify(body);
            }

            const response = await fetch(
              `${this.config.backendUrl}${endpoint}`,
              options
            );

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            return await response.json();
          },

          // UI 辅助方法
          showToast(message, type = "info") {
            const toastTypes = {
              success: { icon: "check-circle", class: "alert-success" },
              error: { icon: "x-circle", class: "alert-error" },
              warning: { icon: "alert-triangle", class: "alert-warning" },
              info: { icon: "info", class: "alert-info" }
            };

            const config = toastTypes[type] || toastTypes.info;

            this.toast = {
              show: true,
              message,
              class: config.class,
              icon: config.icon
            };

            this.$nextTick(() => {
              lucide.createIcons();
            });

            // 自动隐藏
            setTimeout(() => {
              this.toast.show = false;
            }, 5000);
          },

          toggleSignUp() {
            this.auth.isSignUp = !this.auth.isSignUp;
            this.clearAuthErrors();
            this.$nextTick(() => {
              lucide.createIcons();
            });
          },

          clearAuthForm() {
            this.auth.email = "";
            this.auth.password = "";
            this.clearAuthErrors();
          },

          clearAuthErrors() {
            this.auth.errors = {};
          },

          getUserInitials() {
            if (!this.user || !this.user.email) return "??";
            return this.user.email
              .split("@")[0]
              .substring(0, 2)
              .toUpperCase();
          },

          // 主题管理
          initTheme() {
            try {
              const savedTheme = localStorage.getItem("theme") || "light";
              this.darkMode = savedTheme === "dark";
              document.documentElement.setAttribute("data-theme", savedTheme);
            } catch (error) {
              console.warn("localStorage not available, using default theme");
              this.darkMode = false;
            }
          },

          toggleTheme() {
            const theme = this.darkMode ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", theme);

            try {
              localStorage.setItem("theme", theme);
            } catch (error) {
              console.warn(
                "localStorage not available, theme preference not saved"
              );
            }
          }
        }));
      });

      // HTMX 事件监听
      document.addEventListener("DOMContentLoaded", () => {
        // HTMX 全局配置
        htmx.config.defaultSwapStyle = "innerHTML";
        htmx.config.requestClass = "loading";
        htmx.config.timeout = 10000;

        // HTMX 错误处理
        document.body.addEventListener("htmx:responseError", evt => {
          console.error("HTMX response error:", evt.detail);
          const alpineData = Alpine.$data(document.body);
          if (alpineData && alpineData.showToast) {
            alpineData.showToast(
              "Request failed: " + evt.detail.xhr.statusText,
              "error"
            );
          }
        });

        document.body.addEventListener("htmx:timeout", evt => {
          console.error("HTMX timeout:", evt.detail);
          const alpineData = Alpine.$data(document.body);
          if (alpineData && alpineData.showToast) {
            alpineData.showToast("Request timeout", "error");
          }
        });

        // 请求完成后重新创建图标
        document.body.addEventListener("htmx:afterRequest", () => {
          setTimeout(() => {
            lucide.createIcons();
          }, 50);
        });

        console.log("HTMX event listeners configured");
      });

      // 全局错误处理
      window.addEventListener("error", e => {
        console.error("Global error:", e.error);
        if (typeof Sentry !== "undefined") {
          Sentry.captureException(e.error);
        }
      });

      window.addEventListener("unhandledrejection", e => {
        console.error("Unhandled promise rejection:", e.reason);
        if (typeof Sentry !== "undefined") {
          Sentry.captureException(e.reason);
        }
        e.preventDefault();
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dev Admin Dashboard</title>

    <!-- Tailwind CSS + DaisyUI -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Sentry Error Tracking -->
    <script
      src="https://js.sentry-cdn.com/d2a200c0751f88c697a50ea7adb176e8.min.js"
      crossorigin="anonymous"
    ></script>

    <style>
      [x-cloak] {
        display: none !important;
      }

      /* Active menu item styling */
      .dropdown-content .active {
        background-color: hsl(var(--p) / 0.1);
        color: hsl(var(--p));
        font-weight: 600;
      }

      /* Page transition animation */
      #main-content {
        transition: opacity 0.3s ease-in-out;
      }

      #main-content.fade-in {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body class="bg-base-100 min-h-screen" x-data="devAdminData()">
    <!-- Toast Container -->
    <div class="toast toast-end z-50" x-show="toast.show" x-transition>
      <div class="alert" :class="toast.class">
        <i :data-lucide="toast.icon" class="w-5 h-5"></i>
        <span x-text="toast.message"></span>
      </div>
    </div>

    <!-- Loading Screen -->
    <div
      x-show="currentView === 'loading'"
      class="flex items-center justify-center min-h-screen"
      x-cloak
    >
      <div class="text-center">
        <div class="loading loading-spinner loading-lg text-primary"></div>
        <p class="mt-4 text-base-content" x-text="loadingMessage"></p>
      </div>
    </div>

    <!-- Authentication Container -->
    <div
      x-show="currentView === 'auth'"
      class="min-h-screen bg-base-200 flex items-center justify-center p-4"
      x-cloak
    >
      <div class="card w-full max-w-md bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title text-center justify-center mb-6">
            <i data-lucide="shield-check" class="w-6 h-6 text-primary"></i>
            Dev Admin Login
          </h2>

          <!-- OAuth Login Buttons -->
          <div class="space-y-3 mb-4">
             <button
               @click="signInWithOAuth('google')"
               :disabled="authLoading"
               class="btn btn-outline btn-block"
             >
              <svg class="w-5 h-5" viewBox="0 0 24 24">
                <path
                  fill="currentColor"
                  d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                />
                <path
                  fill="currentColor"
                  d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                />
                <path
                  fill="currentColor"
                  d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                />
                <path
                  fill="currentColor"
                  d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                />
              </svg>
              Continue with Google
            </button>

             <button
               @click="signInWithOAuth('github')"
               :disabled="authLoading"
               class="btn btn-outline btn-block"
             >
              <i data-lucide="github" class="w-5 h-5"></i>
              Continue with GitHub
            </button>
          </div>

          <div class="divider">OR</div>

          <!-- Email/Password Form -->
           <form @submit.prevent="handleEmailSubmit" class="space-y-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text">Email</span>
              </label>
              <input
                x-model="auth.email"
                type="email"
                placeholder="Enter your email"
                class="input input-bordered"
                :class="{ 'input-error': auth.errors.email }"
                required
                autocomplete="email"
              />
              <div class="label" x-show="auth.errors.email">
                <span
                  class="label-text-alt text-error"
                  x-text="auth.errors.email"
                ></span>
              </div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Password</span>
              </label>
              <input
                x-model="auth.password"
                type="password"
                placeholder="Enter your password"
                class="input input-bordered"
                :class="{ 'input-error': auth.errors.password }"
                required
                autocomplete="current-password"
              />
              <div class="label" x-show="auth.errors.password">
                <span
                  class="label-text-alt text-error"
                  x-text="auth.errors.password"
                ></span>
              </div>
            </div>

            <button
              type="submit"
              :disabled="authLoading"
              class="btn btn-primary btn-block"
              :class="{ 'loading': authLoading }"
            >
              <template x-if="!authLoading">
                <i
                  :data-lucide="auth.isSignUp ? 'user-plus' : 'log-in'"
                  class="w-5 h-5"
                ></i>
              </template>
              <span x-text="auth.isSignUp ? 'Sign Up' : 'Sign In'"></span>
            </button>
          </form>

          <!-- Sign Up Toggle -->
          <div class="text-center mt-4">
             <button @click="toggleSignUp" class="link link-primary text-sm">
              <span
                x-text="auth.isSignUp ? 'Already have an account? Sign in' : 'Need an account? Sign up'"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </div>

   <!-- Main Application Container -->
   <div x-show="currentView === 'app'" class="min-h-screen" x-cloak>
     <!-- Navigation Header -->
     <div class="navbar bg-base-100 shadow-lg">
       <div class="navbar-start">
         <h1 class="text-xl font-bold text-primary">
           <i data-lucide="code" class="w-6 h-6 inline mr-2"></i>
           Dev Admin
         </h1>
       </div>

       <div class="navbar-end">
         <!-- Theme Toggler -->
         <label class="swap swap-rotate mr-2">
            <input type="checkbox" @change="toggleTheme" x-model="darkMode" />
           <i data-lucide="sun" class="swap-on w-5 h-5"></i>
           <i data-lucide="moon" class="swap-off w-5 h-5"></i>
         </label>

         <div class="dropdown dropdown-end">
           <div
             tabindex="0"
             role="button"
             class="btn btn-ghost btn-circle avatar placeholder"
           >
             <div class="w-10 rounded-full bg-neutral text-neutral-content">
               <img
                 x-show="user && user.user_metadata && user.user_metadata.avatar_url"
                 :src="user && user.user_metadata ? user.user_metadata.avatar_url : ''"
                 class="rounded-full"
                 alt="User Avatar"
               />
                <span
                  x-show="!user || !user.user_metadata || !user.user_metadata.avatar_url"
                  class="text-xl"
                  x-text="getUserInitials()"
                ></span>
             </div>
           </div>
            <ul
              tabindex="0"
              class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52"
            >
                <li>
                  <a @click.prevent="handleMenuClick($event, 'dashboard')" href="#" :class="currentPage === 'dashboard' ? 'active' : ''">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                    Dashboard
                  </a>
                </li>
                <li>
                  <a @click.prevent="handleMenuClick($event, 'onboarding')" href="#" :class="currentPage === 'onboarding' ? 'active' : ''">
                    <i data-lucide="user-check" class="w-4 h-4"></i>
                    Onboarding
                  </a>
                </li>
                <li>
                  <a @click.prevent="handleMenuClick($event, 'profile')" href="#" :class="currentPage === 'profile' ? 'active' : ''">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    Profile
                  </a>
                </li>
              <li>
                <hr class="my-2" />
              </li>
              <li>
                 <button @click="signOut" class="text-error flex items-center w-full text-left px-4 py-2 hover:bg-base-200" hx-disable>
                  <i data-lucide="log-out" class="w-4 h-4 mr-2"></i>
                  Logout
                </button>
              </li>
            </ul>
         </div>
       </div>
     </div>

      <!-- Main Content Area -->
      <div class="container mx-auto p-4">
         <!-- Virtual Pages Container -->
         <div id="main-content">
          <!-- Dashboard Page -->
          <div x-show="currentPage === 'dashboard'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
           <!-- Welcome Card -->
           <div
             class="card bg-gradient-to-r from-primary to-secondary text-primary-content col-span-full"
           >
             <div class="card-body">
               <h2 class="card-title">
                 <i data-lucide="hand-heart" class="w-6 h-6"></i>
                 Welcome back!
               </h2>
               <p>Your development admin dashboard is ready to go.</p>
             </div>
           </div>

           <!-- Stats Cards -->
           <div class="card bg-base-100 shadow-xl">
             <div class="card-body">
               <div class="flex items-center justify-between">
                 <div>
                   <p class="text-base-content/60">Total Projects</p>
                   <p class="text-3xl font-bold">12</p>
                 </div>
                 <i data-lucide="folder" class="w-10 h-10 text-primary"></i>
               </div>
             </div>
           </div>

           <div class="card bg-base-100 shadow-xl">
             <div class="card-body">
               <div class="flex items-center justify-between">
                 <div>
                   <p class="text-base-content/60">Active Tasks</p>
                   <p class="text-3xl font-bold">8</p>
                 </div>
                 <i
                   data-lucide="check-circle"
                   class="w-10 h-10 text-success"
                 ></i>
               </div>
             </div>
           </div>

           <div class="card bg-base-100 shadow-xl">
             <div class="card-body">
               <div class="flex items-center justify-between">
                 <div>
                   <p class="text-base-content/60">Issues</p>
                   <p class="text-3xl font-bold">3</p>
                 </div>
                 <i
                   data-lucide="alert-circle"
                   class="w-10 h-10 text-warning"
                 ></i>
               </div>
             </div>
           </div>

          </div>

          <!-- Profile Page -->
          <div x-show="currentPage === 'profile'" x-cloak>
            <div class="max-w-4xl mx-auto space-y-6">
              <!-- Profile Header -->
              <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                  <div class="flex flex-col md:flex-row items-center gap-6">
                       <div class="avatar">
                         <div class="w-24 h-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                           <img :src="getUserAvatar()" alt="Profile Avatar" />
                         </div>
                       </div>
                    <div class="text-center md:text-left">
                       <h1 class="text-3xl font-bold" x-text="getUserDisplayName()"></h1>
                      <p class="text-base-content/70 text-lg" x-text="user?.email"></p>
                      <div class="flex flex-wrap gap-2 mt-3">
                        <span class="badge badge-primary">Developer</span>
                      </div>
                    </div>
                    <div class="ml-auto">
                      <button class="btn btn-primary" disabled title="Edit functionality coming soon">
                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                        Edit Profile
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Profile Details Grid -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Personal Information -->
                <div class="card bg-base-100 shadow-xl">
                  <div class="card-body">
                    <h2 class="card-title">
                      <i data-lucide="user" class="w-5 h-5"></i>
                      Personal Information
                    </h2>
                    <div class="space-y-4">
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">Full Name</span>
                        </label>
                         <div class="bg-base-200 p-3 rounded-lg" x-text="getUserFullName() || 'Not provided'"></div>
                      </div>
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">Email</span>
                        </label>
                        <div class="bg-base-200 p-3 rounded-lg flex items-center gap-2">
                          <span x-text="user?.email"></span>
                          <span class="badge badge-success badge-sm" x-show="user?.email_confirmed_at">Verified</span>
                          <span class="badge badge-warning badge-sm" x-show="!user?.email_confirmed_at">Unverified</span>
                        </div>
                      </div>
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">Username</span>
                        </label>
                        <div class="bg-base-200 p-3 rounded-lg" x-text="user?.username || 'Not set'"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Account Information -->
                <div class="card bg-base-100 shadow-xl">
                  <div class="card-body">
                    <h2 class="card-title">
                      <i data-lucide="settings" class="w-5 h-5"></i>
                      Account Information
                    </h2>
                    <div class="space-y-4">
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">User ID</span>
                        </label>
                        <div class="bg-base-200 p-3 rounded-lg font-mono text-sm" x-text="user?.id"></div>
                      </div>
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">Joined</span>
                        </label>
                         <div class="bg-base-200 p-3 rounded-lg" x-text="formatDate(user?.created_at)"></div>
                      </div>
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">Last Sign In</span>
                        </label>
                         <div class="bg-base-200 p-3 rounded-lg" x-text="formatDate(user?.last_sign_in_at)"></div>
                      </div>
                      <div class="form-control">
                        <label class="label">
                          <span class="label-text font-semibold">Authentication Provider</span>
                        </label>
                        <div class="bg-base-200 p-3 rounded-lg flex items-center gap-2">
                          <span x-text="user?.app_metadata?.provider || 'email'"></span>
                          <i data-lucide="shield-check" class="w-4 h-4 text-success"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Onboarding Page -->
          <div x-show="currentPage === 'onboarding'" x-cloak>
            <div class="max-w-4xl mx-auto space-y-8">
              <!-- Welcome Header -->
              <div class="text-center space-y-4">
                <div class="avatar">
                  <div class="w-20 h-20 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center">
                    <i data-lucide="user-check" class="w-10 h-10 text-primary-content"></i>
                  </div>
                </div>
                 <h1 class="text-4xl font-bold text-primary" x-text="'Welcome to Dev Admin, ' + getUserDisplayName() + '!'"></h1>
                <p class="text-lg text-base-content/70 max-w-2xl mx-auto">
                  Let's get you set up and ready to manage your development environment.
                  This onboarding guide will help you understand the key features and get started quickly.
                </p>
              </div>

              <!-- Progress Indicator -->
              <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                  <h2 class="card-title">
                    <i data-lucide="target" class="w-5 h-5"></i>
                    Your Setup Progress
                  </h2>
                  <div class="space-y-4">
                    <div class="flex items-center gap-4">
                      <div class="flex-1">
                        <div class="flex justify-between text-sm mb-1">
                          <span>Profile Setup</span>
                          <span>100%</span>
                        </div>
                        <progress class="progress progress-primary w-full" value="100" max="100"></progress>
                      </div>
                      <i data-lucide="check-circle" class="w-6 h-6 text-success"></i>
                    </div>
                    <div class="flex items-center gap-4">
                      <div class="flex-1">
                        <div class="flex justify-between text-sm mb-1">
                          <span>Authentication</span>
                          <span>100%</span>
                        </div>
                        <progress class="progress progress-primary w-full" value="100" max="100"></progress>
                      </div>
                      <i data-lucide="check-circle" class="w-6 h-6 text-success"></i>
                    </div>
                    <div class="flex items-center gap-4">
                      <div class="flex-1">
                        <div class="flex justify-between text-sm mb-1">
                          <span>Dashboard Exploration</span>
                          <span x-text="currentPage === 'dashboard' ? '100%' : '25%'"></span>
                        </div>
                        <progress class="progress progress-primary w-full" :value="currentPage === 'dashboard' ? 100 : 25" max="100"></progress>
                      </div>
                      <i data-lucide="check-circle" class="w-6 h-6 text-success" x-show="currentPage === 'dashboard'"></i>
                      <i data-lucide="circle" class="w-6 h-6 text-base-content/50" x-show="currentPage !== 'dashboard'"></i>
                    </div>
                  </div>
                </div>
              </div>


              <!-- Footer Note -->
              <div class="text-center text-base-content/60">
                <p>Need help? Check the browser console for detailed logs or contact your administrator.</p>
              </div>
            </div>
          </div>
         </div>
        </div>
      </div>
    </div>

    <script>
      // Define Alpine component data
      window.devAdminData = () => ({
        currentView: 'loading',
        currentPage: 'dashboard',
        loadingMessage: 'Initializing...',
        configLoaded: false,
        authLoading: false,

        config: {
          supabaseUrl: "",
          supabaseKey: "",
          backendUrl: "",
          sentryDsn: "",
          sentryEnvironment: "development",
          sentryEnabled: true
        },

        auth: {
          email: "",
          password: "",
          isSignUp: false,
          errors: {}
        },

        user: null,
        supabase: null,
        darkMode: false,
        toast: {
          show: false,
          message: "",
          class: "",
          icon: "info"
        },

        async init() {
          console.log("Initializing Dev Admin Dashboard...");
          console.log("Page URL:", window.location.href);
          console.log("User Agent:", navigator.userAgent);

          try {
            this.initTheme();
            await this.$nextTick();

            if (typeof lucide !== "undefined" && lucide.createIcons) {
              lucide.createIcons();
            }

            await this.loadInitialData();
          } catch (error) {
            console.error("Failed to initialize:", error);
            console.error("Error stack:", error.stack);
            this.showToast("Initialization failed: " + error.message, "error");
            this.currentView = "auth";
          }
        },

        async loadInitialData() {
          try {
            await this.loadConfig();

            if (this.configLoaded) {
              await this.initializeApp();
            } else {
              throw new Error("Configuration not loaded");
            }
          } catch (error) {
            console.error("Config loading failed:", error.message);
            console.log("Using fallback configuration...");
            this.configLoaded = true;
            this.config = {
              supabaseUrl: null,
              supabaseKey: null,
              backendUrl: "",
              sentryDsn: "",
              sentryEnvironment: "development",
              sentryEnabled: false
            };
            this.showToast("Using default configuration", "warning");
            await this.initializeApp();
          }
        },

        async loadConfig() {
          try {
            console.log("Attempting to load config from /dev/settings...");
            console.log("Current URL:", window.location.href);

            try {
              const testResponse = await fetch("/", { method: "HEAD" });
              console.log("Server connectivity test:", testResponse.status);
            } catch (connectError) {
              console.warn("Server connectivity test failed:", connectError.message);
            }

            const response = await fetch("/dev/settings", {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json"
              }
            });

            console.log("Response status:", response.status);
            console.log("Response ok:", response.ok);

            if (!response.ok) {
              console.error("Bad response:", response.status, response.statusText);
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log("Raw response data:", data);

            if (data && data.data) {
              this.config = { ...this.config, ...data.data };
              this.configLoaded = true;
              console.log("Configuration loaded successfully:", this.config);
            } else {
              console.error("Invalid response format - missing data field");
              throw new Error("Invalid configuration response format");
            }
          } catch (error) {
            console.error("Failed to load configuration:", error);
            console.error("Error type:", error.constructor.name);
            console.error("Error message:", error.message);
            this.configLoaded = false;
            throw error;
          }
        },

        async initializeApp() {
          if (!this.configLoaded) {
            throw new Error("Cannot initialize app without configuration");
          }

          this.loadingMessage = "Setting up services...";

          try {
            if (this.config.sentryEnabled && this.config.sentryDsn) {
              this.initSentry();
            }

            if (this.config.supabaseUrl && this.config.supabaseKey) {
              const supabaseInitialized = this.initSupabase();
              if (supabaseInitialized) {
                await this.checkSession();
              } else {
                this.currentView = "auth";
                return;
              }
            } else {
              this.showToast("Supabase not configured", "warning");
              this.currentView = "auth";
              return;
            }

            console.log("Application initialization completed");
          } catch (error) {
            console.error("App initialization failed:", error);
            this.showToast("Application setup failed: " + error.message, "error");
            this.currentView = "auth";
          }
        },

        initSupabase() {
          try {
            this.supabase = supabase.createClient(
              this.config.supabaseUrl,
              this.config.supabaseKey
            );

            this.supabase.auth.onAuthStateChange((event, session) => {
              this.handleAuthStateChange(event, session);
            });

            return true;
          } catch (error) {
            console.error("Supabase initialization failed:", error.message);
            return false;
          }
        },

        initSentry() {
          if (!this.config.sentryDsn) {
            console.log("Sentry DSN not configured");
            return;
          }

          try {
            Sentry.init({
              dsn: this.config.sentryDsn,
              environment: this.config.sentryEnvironment,
              tracesSampleRate: this.config.sentryEnvironment === "production" ? 0.1 : 1.0
            });
            console.log("Sentry initialized successfully");
          } catch (error) {
            console.error("Sentry initialization failed:", error);
          }
        },

        async checkSession() {
          if (!this.supabase) {
            this.currentView = "auth";
            return;
          }

          try {
            const { data: { session }, error } = await this.supabase.auth.getSession();
            if (error) throw error;

            if (session && session.user) {
              this.user = session.user;
              this.currentView = "app";
              this.currentPage = "dashboard";
            } else {
              this.currentView = "auth";
            }
          } catch (error) {
            console.error("Session check failed:", error.message);
            this.showToast("Session check failed: " + error.message, "error");
            this.currentView = "auth";
          }
        },

        handleAuthStateChange(event, session) {
          if (event === "SIGNED_IN" && session && session.user) {
            console.log("User signed in via auth state change:", session.user.email);
            this.user = session.user;
            this.currentView = "app";
            this.showToast("Login successful!", "success");
            this.currentPage = "dashboard";
          } else if (event === "SIGNED_OUT") {
            console.log("User signed out via auth state change");
            this.user = null;
            this.currentView = "auth";
          }
        },

        async signInWithOAuth(provider) {
          if (!this.supabase) {
            this.showToast("Authentication not configured", "warning");
            return;
          }

          console.log(`Attempting ${provider} OAuth login...`);
          this.authLoading = true;

          try {
            const { error } = await this.supabase.auth.signInWithOAuth({
              provider,
              options: { redirectTo: window.location.href }
            });
            if (error) throw error;
          } catch (error) {
            console.error(`${provider} login failed:`, error);
            this.showToast(`${provider} login failed: ${error.message}`, "error");
          } finally {
            this.authLoading = false;
          }
        },

        async handleEmailSubmit() {
          this.clearAuthErrors();

          if (!this.auth.email) {
            this.auth.errors.email = "Email is required";
            return;
          }
          if (!this.auth.password) {
            this.auth.errors.password = "Password is required";
            return;
          }

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(this.auth.email)) {
            this.auth.errors.email = "Invalid email format";
            return;
          }

          if (!this.supabase) {
            this.showToast("Authentication not configured", "warning");
            return;
          }

          this.authLoading = true;

          try {
            if (this.auth.isSignUp) {
              await this.signUpWithEmail();
            } else {
              await this.signInWithEmail();
            }
          } finally {
            this.authLoading = false;
          }
        },

        async signInWithEmail() {
          console.log("Attempting email login...");

          try {
            const { data, error } = await this.supabase.auth.signInWithPassword({
              email: this.auth.email,
              password: this.auth.password
            });

            if (error) throw error;

            console.log("Email login successful:", data.user.email);
            this.user = data.user;
            this.currentView = "app";
            this.showToast("Login successful!", "success");
            this.clearAuthForm();
            this.currentPage = "dashboard";
          } catch (error) {
            console.error("Email login failed:", error);
            this.showToast("Login failed: " + error.message, "error");
          }
        },

        async signUpWithEmail() {
          console.log("Attempting email signup...");

          try {
            const { error } = await this.supabase.auth.signUp({
              email: this.auth.email,
              password: this.auth.password
            });

            if (error) throw error;

            this.showToast("Account created! Please check your email for verification.", "success");
            this.clearAuthForm();
          } catch (error) {
            console.error("Email signup failed:", error);
            this.showToast("Sign up failed: " + error.message, "error");
          }
        },

        async signOut() {
          console.log("User signing out...");

          try {
            if (this.supabase) {
              const { error } = await this.supabase.auth.signOut();
              if (error) throw error;
            }
            this.showToast("Logged out successfully", "success");
          } catch (error) {
            console.error("Supabase logout failed:", error);
            this.showToast("Logout failed: " + error.message, "error");
          }

          this.user = null;
          this.currentView = "auth";
        },

        showToast(message, type = "info") {
          const toastTypes = {
            success: { icon: "check-circle", class: "alert-success" },
            error: { icon: "x-circle", class: "alert-error" },
            warning: { icon: "alert-triangle", class: "alert-warning" },
            info: { icon: "info", class: "alert-info" }
          };

          const config = toastTypes[type] || toastTypes.info;

          this.toast = {
            show: true,
            message,
            class: config.class,
            icon: config.icon
          };

          this.$nextTick(() => {
            if (typeof lucide !== "undefined" && lucide.createIcons) {
              lucide.createIcons();
            }
          });

          setTimeout(() => {
            this.toast.show = false;
          }, 5000);
        },

        toggleSignUp() {
          this.auth.isSignUp = !this.auth.isSignUp;
          this.clearAuthErrors();
          this.$nextTick(() => {
            if (typeof lucide !== "undefined" && lucide.createIcons) {
              lucide.createIcons();
            }
          });
        },

        clearAuthForm() {
          this.auth.email = "";
          this.auth.password = "";
          this.clearAuthErrors();
        },

        clearAuthErrors() {
          this.auth.errors = {};
        },

        getUserInitials() {
          if (!this.user || !this.user.email) return "??";
          return this.user.email.split("@")[0].substring(0, 2).toUpperCase();
        },

        getUserDisplayName() {
          if (!this.user) return "Developer";
          return this.user.user_metadata?.full_name ||
                 this.user.user_metadata?.name ||
                 this.user.email?.split('@')[0] ||
                 "Developer";
        },

        getUserFullName() {
          if (!this.user) return null;
          return this.user.user_metadata?.full_name || this.user.user_metadata?.name;
        },

        getUserAvatar() {
          if (!this.user) return "https://ui-avatars.com/api/?name=Developer";
          return this.user.user_metadata?.avatar_url ||
                 `https://ui-avatars.com/api/?name=${encodeURIComponent(this.user.email)}`;
        },

        formatDate(dateString) {
          if (!dateString) return "Unknown";
          try {
            return new Date(dateString).toLocaleDateString();
          } catch (e) {
            return "Invalid Date";
          }
        },

        initTheme() {
          try {
            const savedTheme = localStorage.getItem("theme") || "light";
            this.darkMode = savedTheme === "dark";
            document.documentElement.setAttribute("data-theme", savedTheme);
          } catch (error) {
            console.warn("localStorage not available, using default theme");
            this.darkMode = false;
          }
        },

        toggleTheme() {
          const theme = this.darkMode ? "dark" : "light";
          document.documentElement.setAttribute("data-theme", theme);

          try {
            localStorage.setItem("theme", theme);
          } catch (error) {
            console.warn("localStorage not available, theme preference not saved");
          }
        },

        handleMenuClick(event, page) {
          console.log('Menu click:', page);
          this.currentPage = page;

          // Close dropdown immediately
          const dropdown = event.target.closest('.dropdown');
          if (dropdown) {
            const trigger = dropdown.querySelector('[tabindex="0"]');
            if (trigger) {
              trigger.blur();
              // Also remove focus and close dropdown by clicking outside
              document.activeElement.blur();
            }
          }

          // Additional cleanup to ensure dropdown closes
          setTimeout(() => {
            document.body.click();
          }, 50);
        }
      });

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Page loaded");
        if (typeof lucide !== "undefined" && lucide.createIcons) {
          lucide.createIcons();
        }
      });

      // Global error handling
      window.addEventListener("error", e => {
        console.error("Global error:", e.error);
        if (typeof Sentry !== "undefined") {
          Sentry.captureException(e.error);
        }
      });

      window.addEventListener("unhandledrejection", e => {
        console.error("Unhandled promise rejection:", e.reason);
        if (typeof Sentry !== "undefined") {
          Sentry.captureException(e.reason);
        }
        e.preventDefault();
      });
    </script>

    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </body>
</html>
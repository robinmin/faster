<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dev Admin Dashboard</title>

    <!-- External Dependencies -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js" defer></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
    <script
      src="https://js.sentry-cdn.com/d2a200c0751f88c697a50ea7adb176e8.min.js"
      defer
      crossorigin="anonymous"
      id="sentry-script"
      onload="window.sentryLoaded = true; window.dispatchEvent(new Event('sentryReady'));"
      onerror="window.sentryLoadFailed = true;"
    ></script>

    <style>
      /* Core Styles */
      [x-cloak] {
        display: none !important;
      }

      /* Component Styles */
      .dropdown-content .menu-item-active {
        background-color: hsl(var(--p) / 0.1);
        color: hsl(var(--p));
        font-weight: 600;
      }

      .page-transition {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }

      .page-enter {
        opacity: 0;
        transform: translateY(-10px);
      }

      .page-enter-active {
        opacity: 1;
        transform: translateY(0);
      }

      /* Loading States */
      .loading-overlay {
        background-color: hsl(var(--b1) / 0.9);
        backdrop-filter: blur(4px);
      }
    </style>
  </head>

  <body class="bg-base-100 min-h-screen" x-data="devAdminApp()" x-init="init()">
    <!-- Global Components -->
    <div
      x-data="toastManager()"
      x-show="$store.toast.show"
      x-transition
      class="toast toast-end z-50"
      role="alert"
      aria-live="polite"
    >
      <div class="alert" :class="$store.toast.class">
        <i
          :data-lucide="$store.toast.icon"
          class="w-5 h-5"
          aria-hidden="true"
        ></i>
        <span x-text="$store.toast.message"></span>
      </div>
    </div>

    <!-- Loading Screen -->
    <div
      x-show="$store.app.currentView === 'loading'"
      class="loading-overlay fixed inset-0 flex items-center justify-center"
      x-cloak
    >
      <div class="text-center">
        <div
          class="loading loading-spinner loading-lg text-primary"
          aria-label="Loading"
        ></div>
        <p class="mt-4 text-base-content" x-text="$store.app.loadingMessage">
          Initializing...
        </p>
      </div>
    </div>

    <!-- Authentication View -->
    <div
      x-show="$store.app.currentView === 'auth'"
      class="min-h-screen bg-base-200 flex items-center justify-center p-4"
      x-cloak
    >
      <div class="card w-full max-w-md bg-base-100 shadow-xl">
        <div class="card-body">
          <header class="text-center mb-6">
            <h1 class="card-title justify-center">
              <i
                data-lucide="shield-check"
                class="w-6 h-6 text-primary"
                aria-hidden="true"
              ></i>
              Dev Admin Login
            </h1>
          </header>

          <div x-data="authComponent()">
            <!-- OAuth Login Options -->
            <div class="space-y-3 mb-4">
              <template x-for="provider in oauthProviders" :key="provider.id">
                <button
                  @click="signInWithOAuth(provider.id)"
                  :disabled="$store.auth.loading"
                  class="btn btn-outline btn-block"
                  :aria-label="`Continue with ${provider.name}`"
                >
                  <i
                    :data-lucide="provider.icon"
                    class="w-5 h-5"
                    aria-hidden="true"
                  ></i>
                  <span x-text="`Continue with ${provider.name}`"></span>
                </button>
              </template>
            </div>

            <div class="divider">OR</div>

            <!-- Email/Password Form -->
            <form @submit.prevent="handleEmailSubmit" class="space-y-4">
              <div class="form-control">
                <label class="label" for="email-input">
                  <span class="label-text">Email</span>
                </label>
                <input
                  id="email-input"
                  x-model="formData.email"
                  type="email"
                  placeholder="Enter your email"
                  class="input input-bordered"
                  :class="{ 'input-error': formErrors.email }"
                  required
                  autocomplete="email"
                  :disabled="$store.auth.loading"
                />
                <div class="label" x-show="formErrors.email">
                  <span
                    class="label-text-alt text-error"
                    x-text="formErrors.email"
                  ></span>
                </div>
              </div>

              <div class="form-control">
                <label class="label" for="password-input">
                  <span class="label-text">Password</span>
                </label>
                <input
                  id="password-input"
                  x-model="formData.password"
                  type="password"
                  placeholder="Enter your password"
                  class="input input-bordered"
                  :class="{ 'input-error': formErrors.password }"
                  required
                  autocomplete="current-password"
                  :disabled="$store.auth.loading"
                />
                <div class="label" x-show="formErrors.password">
                  <span
                    class="label-text-alt text-error"
                    x-text="formErrors.password"
                  ></span>
                </div>
              </div>

              <button
                type="submit"
                :disabled="$store.auth.loading"
                class="btn btn-primary btn-block"
                :class="{ 'loading': $store.auth.loading }"
              >
                <template x-if="!$store.auth.loading">
                  <i
                    :data-lucide="isSignUp ? 'user-plus' : 'log-in'"
                    class="w-5 h-5"
                    aria-hidden="true"
                  ></i>
                </template>
                <span x-text="isSignUp ? 'Sign Up' : 'Sign In'"></span>
              </button>
            </form>

            <!-- Sign Up Toggle -->
            <div class="text-center mt-4">
              <button @click="toggleSignUp()" class="link link-primary text-sm">
                <span
                  x-text="isSignUp ? 'Already have an account? Sign in' : 'Need an account? Sign up'"
                ></span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Application -->
    <div x-show="$store.app.currentView === 'app'" class="min-h-screen" x-cloak>
      <!-- Navigation Header -->
      <nav
        class="navbar bg-base-100 shadow-lg"
        role="navigation"
        aria-label="Main navigation"
      >
        <div class="navbar-start">
          <h1 class="text-xl font-bold text-primary">
            <i
              data-lucide="code"
              class="w-6 h-6 inline mr-2"
              aria-hidden="true"
            ></i>
            <span class="sr-only">Dev Admin Dashboard</span>
            Dev Admin
          </h1>
        </div>

        <div class="navbar-end">
          <!-- Theme Toggle -->
          <div class="mr-2" x-data="themeToggle()" x-init="init()">
            <button
              @click="toggle()"
              class="btn btn-ghost btn-circle"
              title="Toggle theme"
              aria-label="Toggle between light and dark theme"
            >
              <i
                :data-lucide="isDark ? 'sun' : 'moon'"
                class="w-5 h-5"
                aria-hidden="true"
              ></i>
            </button>
          </div>

          <!-- User Menu -->
          <div class="dropdown dropdown-end" x-data="userMenu()">
            <div
              tabindex="0"
              role="button"
              class="btn btn-ghost btn-circle avatar placeholder"
              aria-label="User menu"
            >
              <div class="w-10 rounded-full bg-neutral text-neutral-content">
                <img
                  x-show="hasAvatar()"
                  :src="getAvatarUrl()"
                  class="rounded-full"
                  alt="User Avatar"
                  loading="lazy"
                />
                <span
                  x-show="!hasAvatar()"
                  class="text-xl"
                  x-text="getInitials()"
                  aria-label="User initials"
                ></span>
              </div>
            </div>

            <ul
              tabindex="0"
              class="mt-3 z-[1] p-2 shadow menu menu-sm dropdown-content bg-base-100 rounded-box w-52"
              role="menu"
            >
              <template x-for="item in menuItems" :key="item.id">
                <li role="none">
                  <a
                    @click.prevent="selectMenuItem(item)"
                    href="#"
                    :class="item.id === $store.app.currentPage ? 'menu-item-active' : ''"
                    role="menuitem"
                    :aria-current="item.id === $store.app.currentPage ? 'page' : null"
                  >
                    <i
                      :data-lucide="item.icon"
                      class="w-4 h-4"
                      aria-hidden="true"
                    ></i>
                    <span x-text="item.label"></span>
                  </a>
                </li>
              </template>
              <li role="none"><hr class="my-2" /></li>
              <li role="none">
                <button
                  @click="signOut()"
                  class="text-error flex items-center w-full text-left px-4 py-2 hover:bg-base-200"
                  role="menuitem"
                >
                  <i
                    data-lucide="log-out"
                    class="w-4 h-4 mr-2"
                    aria-hidden="true"
                  ></i>
                  Logout
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="container mx-auto p-4" x-data="pageManager()">
        <div
          class="page-transition"
          :class="{ 'page-enter': isTransitioning, 'page-enter-active': !isTransitioning }"
        >
          <!-- Dashboard Page -->
          <div
            x-show="$store.app.currentPage === 'dashboard'"
            x-data="dashboardPage()"
          >
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Welcome Card -->
              <div
                class="card bg-gradient-to-r from-primary to-secondary text-primary-content col-span-full"
              >
                <div class="card-body">
                  <h2 class="card-title">
                    <i
                      data-lucide="hand-heart"
                      class="w-6 h-6"
                      aria-hidden="true"
                    ></i>
                    <span
                      x-text="`Welcome back, ${getUserDisplayName()}!`"
                    ></span>
                  </h2>
                  <p>Your development admin dashboard is ready to go.</p>
                </div>
              </div>

              <!-- Dynamic Stats Cards -->
              <template x-for="stat in stats" :key="stat.id">
                <div class="card bg-base-100 shadow-xl">
                  <div class="card-body">
                    <div class="flex items-center justify-between">
                      <div>
                        <p class="text-base-content/60" x-text="stat.label"></p>
                        <p class="text-3xl font-bold" x-text="stat.value"></p>
                      </div>
                      <i
                        :data-lucide="stat.icon"
                        :class="`w-10 h-10 text-${stat.color}`"
                        aria-hidden="true"
                      ></i>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Profile Page -->
          <div
            x-show="$store.app.currentPage === 'profile'"
            x-data="profilePage()"
            x-cloak
          >
            <div class="max-w-4xl mx-auto space-y-6">
              <!-- Profile Header -->
              <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                  <div class="flex flex-col md:flex-row items-center gap-6">
                    <div class="avatar">
                      <div
                        class="w-24 h-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2"
                      >
                        <img
                          :src="getUserAvatarUrl()"
                          :alt="`${getUserDisplayName()}'s avatar`"
                          loading="lazy"
                        />
                      </div>
                    </div>
                    <div class="text-center md:text-left flex-1">
                      <h1
                        class="text-3xl font-bold"
                        x-text="getUserDisplayName()"
                      ></h1>
                      <p
                        class="text-base-content/70 text-lg"
                        x-text="getUserEmail()"
                      ></p>
                      <div class="flex flex-wrap gap-2 mt-3">
                        <template x-for="role in getUserRoles()" :key="role">
                          <span
                            class="badge badge-primary"
                            x-text="formatRole(role)"
                          ></span>
                        </template>
                        <span
                          x-show="!getUserRoles().length"
                          class="badge badge-neutral"
                          >No roles assigned</span
                        >
                      </div>
                    </div>
                    <div>
                      <button
                        class="btn btn-primary"
                        disabled
                        title="Edit functionality coming soon"
                        aria-describedby="edit-tooltip"
                      >
                        <i
                          data-lucide="edit-3"
                          class="w-4 h-4"
                          aria-hidden="true"
                        ></i>
                        Edit Profile
                      </button>
                      <div id="edit-tooltip" class="sr-only">
                        Edit functionality coming soon
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Profile Information Grid -->
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Personal Information -->
                <div class="card bg-base-100 shadow-xl">
                  <div class="card-body">
                    <h2 class="card-title">
                      <i
                        data-lucide="user"
                        class="w-5 h-5"
                        aria-hidden="true"
                      ></i>
                      Personal Information
                    </h2>
                    <div class="space-y-4">
                      <template x-for="field in personalFields" :key="field.id">
                        <div class="form-control">
                          <label class="label">
                            <span
                              class="label-text font-semibold"
                              x-text="field.label"
                            ></span>
                          </label>
                          <div
                            class="bg-base-200 p-3 rounded-lg flex items-center gap-2"
                          >
                            <span x-text="field.value || 'Not provided'"></span>
                            <template x-if="field.badge">
                              <span
                                :class="`badge badge-${field.badge.type} badge-sm`"
                                x-text="field.badge.text"
                              ></span>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>

                <!-- Account Information -->
                <div class="card bg-base-100 shadow-xl">
                  <div class="card-body">
                    <h2 class="card-title">
                      <i
                        data-lucide="settings"
                        class="w-5 h-5"
                        aria-hidden="true"
                      ></i>
                      Account Information
                    </h2>
                    <div class="space-y-4">
                      <template x-for="field in accountFields" :key="field.id">
                        <div class="form-control">
                          <label class="label">
                            <span
                              class="label-text font-semibold"
                              x-text="field.label"
                            ></span>
                          </label>
                          <div
                            :class="field.mono ? 'bg-base-200 p-3 rounded-lg font-mono text-sm' : 'bg-base-200 p-3 rounded-lg flex items-center gap-2'"
                          >
                            <span x-text="field.value"></span>
                            <template x-if="field.icon">
                              <i
                                :data-lucide="field.icon"
                                class="w-4 h-4 text-success"
                                aria-hidden="true"
                              ></i>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- App State Page -->
          <div
            x-show="$store.app.currentPage === 'app-state'"
            x-data="appStatePage()"
            x-cloak
          >
            <div class="max-w-7xl mx-auto space-y-6">
              <!-- App State Header -->
              <div class="navbar bg-base-100 shadow-lg rounded-box">
                <div class="navbar-start">
                  <div class="flex items-center gap-3">
                    <div class="avatar">
                      <div
                        class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent to-secondary flex items-center justify-center"
                      >
                        <i
                          data-lucide="terminal"
                          class="w-5 h-5 text-accent-content"
                          aria-hidden="true"
                        ></i>
                      </div>
                    </div>
                    <div>
                      <h1
                        class="text-xl font-bold"
                        x-text="getPageTitle()"
                      ></h1>
                      <p
                        class="text-sm text-base-content/60"
                        x-text="getPageDescription()"
                      ></p>
                    </div>
                  </div>
                </div>
                <div class="navbar-end">
                  <div class="flex gap-2">
                    <div class="dropdown dropdown-end">
                      <div
                        tabindex="0"
                        role="button"
                        class="btn btn-ghost btn-sm"
                      >
                        <i
                          data-lucide="download"
                          class="w-4 h-4"
                          aria-hidden="true"
                        ></i>
                        Export
                      </div>
                      <ul
                        tabindex="0"
                        class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52"
                      >
                        <li>
                          <a @click="exportAsJSON()"
                            ><i data-lucide="file-text" class="w-4 h-4"></i>
                            JSON</a
                          >
                        </li>
                        <li>
                          <a @click="copyToClipboard()"
                            ><i data-lucide="copy" class="w-4 h-4"></i> Copy</a
                          >
                        </li>
                      </ul>
                    </div>
                    <button
                      @click="loadHealthData()"
                      class="btn btn-primary btn-sm"
                      :class="{ 'loading': loading }"
                      :disabled="loading"
                    >
                      <i
                        data-lucide="refresh-cw"
                        class="w-4 h-4"
                        aria-hidden="true"
                      ></i>
                      <span x-show="!loading">Refresh</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Code Editor Interface -->
              <div
                x-show="appStateData && Object.keys(appStateData).length > 0"
                class="mockup-window border-2 border-base-300 bg-base-100 shadow-2xl"
              >
                <div class="flex justify-center px-4 py-4 bg-base-200">
                  <!-- Code Editor Mockup -->
                  <div class="w-full">
                    <!-- Editor Header -->
                    <div
                      class="flex items-center justify-between bg-base-100 px-4 py-2 border-b border-base-300"
                    >
                      <div class="flex items-center gap-2">
                        <div class="flex gap-1">
                          <div class="w-3 h-3 rounded-full bg-error"></div>
                          <div class="w-3 h-3 rounded-full bg-warning"></div>
                          <div class="w-3 h-3 rounded-full bg-success"></div>
                        </div>
                        <span class="text-sm font-mono text-base-content/60"
                          >app_state.json</span
                        >
                      </div>
                      <div class="flex items-center gap-2">
                        <div class="badge badge-sm badge-accent">Live</div>
                        <span
                          class="text-xs text-base-content/40"
                          x-text="formatTimestamp()"
                        ></span>
                      </div>
                    </div>

                    <!-- Line Numbers & Code -->
                    <div class="flex bg-base-100">
                      <!-- Line Numbers -->
                      <div
                        class="bg-base-200 px-4 py-4 text-xs font-mono text-base-content/40 select-none min-w-[60px] border-r border-base-300 overflow-auto max-h-[500px]"
                      >
                        <template x-for="line in getLineNumbers()" :key="line">
                          <div class="leading-6 text-right" x-text="line"></div>
                        </template>
                      </div>

                      <!-- Code Content -->
                      <div class="flex-1 p-4 overflow-auto max-h-[500px]">
                        <pre
                          class="text-sm font-mono leading-6 text-base-content"
                          x-html="formatAppStateDataWithSyntax()"
                        ></pre>
                      </div>
                    </div>

                    <!-- Editor Footer -->
                    <div
                      class="flex items-center justify-between bg-base-200 px-4 py-2 border-t border-base-300 text-xs"
                    >
                      <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1">
                          <i data-lucide="type" class="w-3 h-3"></i>
                          JSON
                        </span>
                        <span class="flex items-center gap-1">
                          <i data-lucide="file-text" class="w-3 h-3"></i>
                          <span x-text="getDataSize()"></span>
                        </span>
                      </div>
                      <div class="flex items-center gap-4">
                        <span x-text="getObjectCount()"></span>
                        <div class="flex items-center gap-1">
                          <div class="w-2 h-2 rounded-full bg-success"></div>
                          <span>Ready</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loading State -->
              <div
                x-show="loading && (!appStateData || Object.keys(appStateData).length === 0)"
                class="card bg-base-100 shadow-xl"
              >
                <div class="card-body items-center text-center">
                  <div
                    class="loading loading-spinner loading-lg text-primary"
                  ></div>
                  <h3 class="text-lg font-semibold mt-4">
                    Loading Application State
                  </h3>
                  <p class="text-base-content/60">
                    Fetching real-time data from server...
                  </p>
                </div>
              </div>

              <!-- Empty State -->
              <div
                x-show="!loading && (!appStateData || Object.keys(appStateData).length === 0) && !error"
                class="hero bg-base-200 rounded-box"
              >
                <div class="hero-content text-center py-20">
                  <div class="max-w-md">
                    <div class="mockup-code mb-6 bg-base-100">
                      <pre
                        data-prefix="$"
                      ><code>curl /dev/app_state</code></pre>
                      <pre
                        data-prefix=">"
                        class="text-warning"
                      ><code>No data found</code></pre>
                    </div>
                    <h3 class="text-2xl font-bold">No Application State</h3>
                    <p class="py-4 text-base-content/70">
                      The application state endpoint returned no data. This
                      could be normal during startup or maintenance.
                    </p>
                    <button
                      @click="loadHealthData()"
                      class="btn btn-primary"
                      :class="{ 'loading': loading }"
                      :disabled="loading"
                    >
                      <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                      Check Again
                    </button>
                  </div>
                </div>
              </div>

              <!-- Error State -->
              <div x-show="error" class="alert alert-error shadow-lg">
                <div class="flex items-start gap-3">
                  <i
                    data-lucide="alert-triangle"
                    class="w-6 h-6 flex-shrink-0"
                    aria-hidden="true"
                  ></i>
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">Connection Error</h3>
                    <div
                      class="text-sm opacity-80 mt-1"
                      x-text="error"
                    ></div>
                    <div class="mt-3">
                      <button
                        @click="loadHealthData()"
                        class="btn btn-sm btn-ghost"
                      >
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Retry
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Request State Page -->
          <div
            x-show="$store.app.currentPage === 'request-state'"
            x-data="requestStatePage()"
            x-cloak
          >
            <div class="max-w-7xl mx-auto space-y-6">
              <!-- Request State Header -->
              <div class="navbar bg-base-100 shadow-lg rounded-box">
                <div class="navbar-start">
                  <div class="flex items-center gap-3">
                    <div class="avatar">
                      <div
                        class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent to-secondary flex items-center justify-center"
                      >
                        <i
                          data-lucide="send"
                          class="w-5 h-5 text-accent-content"
                          aria-hidden="true"
                        ></i>
                      </div>
                    </div>
                    <div>
                      <h1
                        class="text-xl font-bold"
                        x-text="getPageTitle()"
                      ></h1>
                      <p
                        class="text-sm text-base-content/60"
                        x-text="getPageDescription()"
                      ></p>
                    </div>
                  </div>
                </div>
                <div class="navbar-end">
                  <div class="flex gap-2">
                    <div class="dropdown dropdown-end">
                      <div
                        tabindex="0"
                        role="button"
                        class="btn btn-ghost btn-sm"
                      >
                        <i
                          data-lucide="download"
                          class="w-4 h-4"
                          aria-hidden="true"
                        ></i>
                        Export
                      </div>
                      <ul
                        tabindex="0"
                        class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52"
                      >
                        <li>
                          <a @click="exportAsJSON()"
                            ><i data-lucide="file-text" class="w-4 h-4"></i>
                            JSON</a
                          >
                        </li>
                        <li>
                          <a @click="copyToClipboard()"
                            ><i data-lucide="copy" class="w-4 h-4"></i> Copy</a
                          >
                        </li>
                      </ul>
                    </div>
                    <button
                      @click="loadHealthData()"
                      class="btn btn-primary btn-sm"
                      :class="{ 'loading': loading }"
                      :disabled="loading"
                    >
                      <i
                        data-lucide="refresh-cw"
                        class="w-4 h-4"
                        aria-hidden="true"
                      ></i>
                      <span x-show="!loading">Refresh</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Code Editor Interface -->
              <div
                x-show="requestStateData && Object.keys(requestStateData).length > 0"
                class="mockup-window border-2 border-base-300 bg-base-100 shadow-2xl"
              >
                <div class="flex justify-center px-4 py-4 bg-base-200">
                  <!-- Code Editor Mockup -->
                  <div class="w-full">
                    <!-- Editor Header -->
                    <div
                      class="flex items-center justify-between bg-base-100 px-4 py-2 border-b border-base-300"
                    >
                      <div class="flex items-center gap-2">
                        <div class="flex gap-1">
                          <div class="w-3 h-3 rounded-full bg-error"></div>
                          <div class="w-3 h-3 rounded-full bg-warning"></div>
                          <div class="w-3 h-3 rounded-full bg-success"></div>
                        </div>
                        <span class="text-sm font-mono text-base-content/60"
                          >request_state.json</span
                        >
                      </div>
                      <div class="flex items-center gap-2">
                        <div class="badge badge-sm badge-accent">Live</div>
                        <span
                          class="text-xs text-base-content/40"
                          x-text="formatTimestamp()"
                        ></span>
                      </div>
                    </div>

                    <!-- Line Numbers & Code -->
                    <div class="flex bg-base-100">
                      <!-- Line Numbers -->
                      <div
                        class="bg-base-200 px-4 py-4 text-xs font-mono text-base-content/40 select-none min-w-[60px] border-r border-base-300 overflow-auto max-h-[500px]"
                      >
                        <template x-for="line in getLineNumbers()" :key="line">
                          <div class="leading-6 text-right" x-text="line"></div>
                        </template>
                      </div>

                      <!-- Code Content -->
                      <div class="flex-1 p-4 overflow-auto max-h-[500px]">
                        <pre
                          class="text-sm font-mono leading-6 text-base-content"
                          x-html="formatRequestStateDataWithSyntax()"
                        ></pre>
                      </div>
                    </div>

                    <!-- Editor Footer -->
                    <div
                      class="flex items-center justify-between bg-base-200 px-4 py-2 border-t border-base-300 text-xs"
                    >
                      <div class="flex items-center gap-4">
                        <span class="flex items-center gap-1">
                          <i data-lucide="type" class="w-3 h-3"></i>
                          JSON
                        </span>
                        <span class="flex items-center gap-1">
                          <i data-lucide="file-text" class="w-3 h-3"></i>
                          <span x-text="getDataSize()"></span>
                        </span>
                      </div>
                      <div class="flex items-center gap-4">
                        <span x-text="getObjectCount()"></span>
                        <div class="flex items-center gap-1">
                          <div class="w-2 h-2 rounded-full bg-success"></div>
                          <span>Ready</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Loading State -->
              <div
                x-show="loading && (!requestStateData || Object.keys(requestStateData).length === 0)"
                class="card bg-base-100 shadow-xl"
              >
                <div class="card-body items-center text-center">
                  <div
                    class="loading loading-spinner loading-lg text-primary"
                  ></div>
                  <h3 class="text-lg font-semibold mt-4">
                    Loading Request State
                  </h3>
                  <p class="text-base-content/60">
                    Fetching real-time request data from server...
                  </p>
                </div>
              </div>

              <!-- Empty State -->
              <div
                x-show="!loading && (!requestStateData || Object.keys(requestStateData).length === 0) && !error"
                class="hero bg-base-200 rounded-box"
              >
                <div class="hero-content text-center py-20">
                  <div class="max-w-md">
                    <div class="mockup-code mb-6 bg-base-100">
                      <pre
                        data-prefix="$"
                      ><code>curl /dev/request_state</code></pre>
                      <pre
                        data-prefix=">"
                        class="text-warning"
                      ><code>No data found</code></pre>
                    </div>
                    <h3 class="text-2xl font-bold">No Request State</h3>
                    <p class="py-4 text-base-content/70">
                      The request state endpoint returned no data. This could be
                      normal during startup or maintenance.
                    </p>
                    <button
                      @click="loadHealthData()"
                      class="btn btn-primary"
                      :class="{ 'loading': loading }"
                      :disabled="loading"
                    >
                      <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                      Check Again
                    </button>
                  </div>
                </div>
              </div>

              <!-- Error State -->
              <div x-show="error" class="alert alert-error shadow-lg">
                <div class="flex items-start gap-3">
                  <i
                    data-lucide="alert-triangle"
                    class="w-6 h-6 flex-shrink-0"
                    aria-hidden="true"
                  ></i>
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">Connection Error</h3>
                    <div
                      class="text-sm opacity-80 mt-1"
                      x-text="error"
                    ></div>
                    <div class="mt-3">
                      <button
                        @click="loadHealthData()"
                        class="btn btn-sm btn-ghost"
                      >
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Retry
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sys Health Page -->
          <div
            x-show="$store.app.currentPage === 'sys-health'"
            x-data="sysHealthPage()"
            x-cloak
          >
            <div class="max-w-7xl mx-auto space-y-6">
              <!-- Sys Health Header -->
              <div class="navbar bg-base-100 shadow-lg rounded-box">
                <div class="navbar-start">
                  <div class="flex items-center gap-3">
                    <div class="avatar">
                      <div
                        class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent to-secondary flex items-center justify-center"
                      >
                        <i
                          data-lucide="heart-pulse"
                          class="w-5 h-5 text-accent-content"
                          aria-hidden="true"
                        ></i>
                      </div>
                    </div>
                    <div>
                      <h1
                        class="text-xl font-bold"
                      >System Health</h1>
                      <p
                        class="text-sm text-base-content/60"
                      >Monitor plugin status and health metrics</p>
                    </div>
                  </div>
                </div>
                <div class="navbar-end">
                  <div class="flex gap-2">
                    <button
                      @click="loadHealthData()"
                      class="btn btn-primary btn-sm"
                      :class="{ 'loading': loading }"
                      :disabled="loading"
                    >
                      <i
                        data-lucide="refresh-cw"
                        class="w-4 h-4"
                        aria-hidden="true"
                      ></i>
                      <span x-show="!loading">Refresh</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Plugin Health Status Cards -->
              <div
                x-show="healthData && Object.keys(healthData).length > 0"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
              >
                <template x-for="[pluginName, pluginHealth] in (healthData ? Object.entries(healthData).filter(([key]) => !['latest_status_check'].includes(key)) : [])" :key="pluginName">
                  <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                      <h2 class="card-title capitalize flex items-center gap-2">
                        <i
                          :data-lucide="getPluginIcon(pluginName)"
                          class="w-5 h-5 text-primary"
                          aria-hidden="true"
                        ></i>
                        <span x-text="pluginName.toUpperCase()"></span>
                      </h2>

                      <!-- Status Badge -->
                      <div class="flex items-center gap-2 mb-3">
                        <div
                          class="badge"
                          :class="getPluginStatus(pluginHealth).color === 'green' ? 'badge-success' : getPluginStatus(pluginHealth).color === 'red' ? 'badge-error' : 'badge-warning'"
                        >
                          <i
                            data-lucide="check-circle"
                            class="w-3 h-3 mr-1"
                            aria-hidden="true"
                          ></i>
                          <span x-text="getPluginStatus(pluginHealth).status"></span>
                        </div>
                      </div>

                      <!-- Plugin Details -->
                      <div class="space-y-2 text-sm">
                        <template x-for="detail in formatPluginData(pluginHealth)" :key="detail.key">
                          <div class="flex justify-between">
                            <span class="text-base-content/60 capitalize" x-text="detail.key"></span>
                            <span
                              class="font-mono text-xs"
                              x-text="detail.value"
                            ></span>
                          </div>
                        </template>
                      </div>

                      <!-- Error Details (if any) -->
                      <div x-show="getPluginStatus(pluginHealth).status === 'error'" class="mt-3">
                        <div class="alert alert-error alert-sm">
                          <i data-lucide="alert-triangle" class="w-4 h-4" aria-hidden="true"></i>
                          <span class="text-xs">Plugin has errors</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Loading State -->
              <div
                x-show="loading && (!healthData || Object.keys(healthData).length === 0)"
                class="card bg-base-100 shadow-xl"
              >
                <div class="card-body items-center text-center">
                  <div
                    class="loading loading-spinner loading-lg text-primary"
                  ></div>
                  <h3 class="text-lg font-semibold mt-4">
                    Loading System Health
                  </h3>
                  <p class="text-base-content/60">
                    Checking plugin status and health metrics...
                  </p>
                </div>
              </div>

              <!-- Empty State -->
              <div
                x-show="!loading && (!healthData || Object.keys(healthData).length === 0) && !error"
                class="hero bg-base-200 rounded-box"
              >
                <div class="hero-content text-center py-20">
                  <div class="max-w-md">
                    <div class="mockup-code mb-6 bg-base-100">
                      <pre data-prefix="$"><code>curl /health</code></pre>
                      <pre data-prefix=">" class="text-warning"><code>No data found</code></pre>
                    </div>
                    <h3 class="text-2xl font-bold">No Health Data</h3>
                    <p class="py-4 text-base-content/70">
                      The health endpoint returned no data. This could be
                      normal during startup or maintenance.
                    </p>
                    <button
                      @click="loadHealthData()"
                      class="btn btn-primary"
                      :class="{ 'loading': loading }"
                      :disabled="loading"
                    >
                      <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                      Check Again
                    </button>
                  </div>
                </div>
              </div>

              <!-- Error State -->
              <div x-show="error" class="alert alert-error shadow-lg">
                <div class="flex items-start gap-3">
                  <i
                    data-lucide="alert-triangle"
                    class="w-6 h-6 flex-shrink-0"
                    aria-hidden="true"
                  ></i>
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">Health Check Error</h3>
                    <div
                      class="text-sm opacity-80 mt-1"
                      x-text="error"
                    ></div>
                    <div class="mt-3">
                      <button
                        @click="loadHealthData()"
                        class="btn btn-sm btn-ghost"
                      >
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Retry
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Onboarding Page -->
          <div
            x-show="$store.app.currentPage === 'onboarding'"
            x-data="onboardingPage()"
            x-cloak
          >
            <div class="max-w-4xl mx-auto space-y-8">
              <!-- Welcome Header -->
              <div class="text-center space-y-4">
                <div class="avatar">
                  <div
                    class="w-20 h-20 rounded-full bg-gradient-to-r from-primary to-secondary flex items-center justify-center"
                  >
                    <i
                      data-lucide="user-check"
                      class="w-10 h-10 text-primary-content"
                      aria-hidden="true"
                    ></i>
                  </div>
                </div>
                <h1
                  class="text-4xl font-bold text-primary"
                  x-text="getHeadlineMessage()"
                ></h1>
                <p class="text-lg text-base-content/70 max-w-2xl mx-auto">
                  Let's get you set up and ready to manage your development
                  environment. This onboarding guide will help you understand
                  the key features and get started quickly.
                </p>
              </div>

              <!-- Progress Indicator -->
              <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                  <h2 class="card-title">
                    <i
                      data-lucide="target"
                      class="w-5 h-5"
                      aria-hidden="true"
                    ></i>
                    Your Setup Progress
                  </h2>
                  <div
                    class="space-y-4"
                    role="group"
                    aria-label="Setup progress"
                  >
                    <template x-for="step in progressSteps" :key="step.id">
                      <div class="flex items-center gap-4">
                        <div class="flex-1">
                          <div class="flex justify-between text-sm mb-1">
                            <span x-text="step.label"></span>
                            <span x-text="`${step.progress}%`"></span>
                          </div>
                          <progress
                            class="progress progress-primary w-full"
                            :value="step.progress"
                            max="100"
                            :aria-label="`${step.label}: ${step.progress}% complete`"
                          ></progress>
                        </div>
                        <i
                          :data-lucide="step.progress === 100 ? 'check-circle' : 'circle'"
                          :class="step.progress === 100 ? 'w-6 h-6 text-success' : 'w-6 h-6 text-base-content/50'"
                          aria-hidden="true"
                        ></i>
                      </div>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Help Footer -->
              <footer class="text-center text-base-content/60">
                <p>
                  Need help? Check the browser console for detailed logs or
                  contact your administrator.
                </p>
              </footer>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- JavaScript Application -->
    <script>
      // Application Constants
      const APP_CONFIG = {
        TOAST_DURATION: 5000,
        API_TIMEOUT: 10000,
        RETRY_ATTEMPTS: 3,
        THEME_STORAGE_KEY: "dev-admin-theme",
        ENDPOINTS: {
          CONFIG: "/dev/settings",
          HEALTH: "/"
        }
      };

      const TOAST_TYPES = {
        success: { icon: "check-circle", class: "alert-success" },
        error: { icon: "x-circle", class: "alert-error" },
        warning: { icon: "alert-triangle", class: "alert-warning" },
        info: { icon: "info", class: "alert-info" }
      };

      // Global Store
      document.addEventListener("alpine:init", () => {
        Alpine.store("app", {
          currentView: "loading",
          currentPage: "dashboard",
          loadingMessage: "Initializing...",
          user: null,
          config: null,
          supabase: null,
          pageData: {}
        });

        Alpine.store("auth", {
          loading: false
        });

        Alpine.store("toast", {
          show: false,
          message: "",
          class: "",
          icon: "info"
        });
      });

      // Utility Functions
      const utils = {
        async withTimeout(promise, ms = APP_CONFIG.API_TIMEOUT) {
          const timeout = new Promise((_, reject) =>
            setTimeout(() => reject(new Error("Operation timed out")), ms)
          );
          return Promise.race([promise, timeout]);
        },

        async retry(fn, attempts = APP_CONFIG.RETRY_ATTEMPTS) {
          for (let i = 0; i < attempts; i++) {
            try {
              return await fn();
            } catch (error) {
              if (i === attempts - 1) throw error;
              await new Promise(resolve =>
                setTimeout(resolve, Math.pow(2, i) * 1000)
              );
            }
          }
        },

        formatDate(dateString) {
          if (!dateString) return "Unknown";
          try {
            return new Date(dateString).toLocaleDateString();
          } catch (e) {
            return "Invalid Date";
          }
        },

        getUserInitials(user) {
          if (!user?.email) return "??";
          return user.email
            .split("@")[0]
            .substring(0, 2)
            .toUpperCase();
        },

        getUserDisplayName(user) {
          if (!user) return "Developer";
          return (
            user.user_metadata?.full_name ||
            user.user_metadata?.name ||
            user.email?.split("@")[0] ||
            "Developer"
          );
        },

        getUserAvatar(user) {
          if (!user) return "https://ui-avatars.com/api/?name=Developer";
          return (
            user.user_metadata?.avatar_url ||
            `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email)}`
          );
        }
      };

      // Centralized API Service with Whitelist Management
      const apiService = {
        // Whitelist of endpoints that don't require authentication
        AUTH_WHITELIST: [
          /^\/auth\/notification\/[^\/]+$/,
          /^\/\.well-known\/appspecific\/com\.chrome\.devtools\.json$/,
          /^\/dev\/admin$/,
          /^\/dev\/settings$/,
          /^\/custom$/
        ],

        // Check if endpoint is in whitelist (doesn't require auth)
        isWhitelisted(endpoint) {
          return this.AUTH_WHITELIST.some(pattern => pattern.test(endpoint));
        },

        async call(endpoint, options = {}) {
          const { method = "GET", data = null, requireAuth } = options;

          const headers = {
            "Content-Type": "application/json",
            Accept: "application/json"
          };

          // Determine if auth is required
          // If requireAuth is explicitly set, use that value
          // Otherwise, require auth unless endpoint is in whitelist
          const needsAuth =
            requireAuth !== undefined
              ? requireAuth
              : !this.isWhitelisted(endpoint);

          // Add auth token if required
          if (needsAuth) {
            const supabase = Alpine.store("app").supabase;

            // Special handling for SIGNED_OUT event - use pending token if available
            if (
              endpoint.includes("/auth/callback/SIGNED_OUT") &&
              window.pendingSignOutToken
            ) {
              headers["Authorization"] = `Bearer ${window.pendingSignOutToken}`;
              // Clear the pending token after use
              delete window.pendingSignOutToken;
            } else if (supabase) {
              try {
                const {
                  data: { session }
                } = await supabase.auth.getSession();
                if (session?.access_token) {
                  headers["Authorization"] = `Bearer ${session.access_token}`;
                } else {
                  throw new Error(
                    "Authentication required but no valid session found"
                  );
                }
              } catch (error) {
                console.error("Could not get auth token for API call:", error);
                throw new Error(
                  `Authentication failed for ${endpoint}: ${error.message}`
                );
              }
            } else {
              throw new Error(
                `Authentication required for ${endpoint} but Supabase not initialized`
              );
            }
          }

          const config = {
            method,
            headers
          };

          if (
            data &&
            (method === "POST" || method === "PUT" || method === "PATCH")
          ) {
            config.body = JSON.stringify(data);
          }

          const response = await utils.withTimeout(fetch(endpoint, config));

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          return await response.json();
        },

        // Specific API methods
        async getConfig() {
          // console.log("Loading configuration...");
          const data = await this.call(APP_CONFIG.ENDPOINTS.CONFIG);

          if (!data?.data) {
            throw new Error("Invalid configuration response format");
          }

          return data.data;
        },

        async getPage(pageId) {
          // console.log(`Loading ${pageId} page data...`);
          if (pageId === "app-state") {
            return await this.call("/dev/app_state");
          }
          if (pageId === "request-state") {
            return await this.call("/dev/request_state");
          }
          if (pageId === "sys-health") {
            return await this.call("/health");
          }
          return await this.call(`/auth/${pageId}`);
        },

        async notifyAuthEvent(event, eventData = {}) {
          console.log(`Notifying backend about auth event: ${event}`);

          // Public events (no auth required): INITIAL_SESSION
          // Private events (auth required): SIGNED_IN, SIGNED_OUT, TOKEN_REFRESHED, USER_UPDATED, PASSWORD_RECOVERY
          const publicEvents = ["INITIAL_SESSION"];
          const isPublicEvent = publicEvents.includes(event);

          const endpoint = isPublicEvent
            ? `/auth/notification/${event}`
            : `/auth/callback/${event}`;

          const data = {
            event: event,
            timestamp: new Date().toISOString(),
            ...eventData
          };

          return await this.call(endpoint, {
            method: "POST",
            data: data
          });
        }
      };

      // Services
      const configService = {
        async load() {
          return await apiService.getConfig();
        },

        getFallbackConfig() {
          return {
            supabaseUrl: null,
            supabaseKey: null,
            backendUrl: "",
            sentryDsn: "",
            sentryEnvironment: "development",
            sentryEnabled: false
          };
        }
      };

      const authService = {
        _supabaseClient: null,

        async initSupabase(config) {
          // Return existing client if already initialized
          if (this._supabaseClient) {
            console.log(
              "Supabase client already initialized, reusing existing instance"
            );
            return this._supabaseClient;
          }

          if (!config.supabaseUrl || !config.supabaseKey) {
            throw new Error("Supabase configuration missing");
          }

          // console.log("Creating new Supabase client instance");
          this._supabaseClient = supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );

          this._supabaseClient.auth.onAuthStateChange((event, session) => {
            this.handleAuthStateChange(event, session);
          });

          return this._supabaseClient;
        },

        async handleAuthStateChange(event, session) {
          const store = Alpine.store("app");
          // console.log(`Supabase auth event: ${event}`);

          try {
            if (event === "SIGNED_IN" && session?.user) {
              await this._handleSignedIn(session, store);
            } else if (event === "SIGNED_OUT") {
              await this._handleSignedOut(store);
            } else if (event === "TOKEN_REFRESHED" && session) {
              await this._handleTokenRefreshed(session, store);
            } else if (event === "USER_UPDATED" && session) {
              await this._handleUserUpdated(session, store);
            } else if (event === "PASSWORD_RECOVERY") {
              await this._handlePasswordRecovery();
            } else if (event === "INITIAL_SESSION") {
              await this._handleInitialSession();
            }
          } catch (error) {
            console.error(`Error handling auth event ${event}:`, error);
            toastService.show(`Auth error: ${error.message}`, "error");
          }
        },

        async _handleSignedIn(session, store) {
          // console.log("User signed in:", session.user.email);
          store.user = session.user;
          store.currentView = "app";
          store.currentPage = "dashboard";
          toastService.show("Login successful!", "success");

          // Notify backend
          await apiService.notifyAuthEvent("SIGNED_IN", {
            session: {
              user: session.user,
              access_token: session.access_token
            }
          });
        },

        async _handleSignedOut(store) {
          // console.log("User signed out");

          // Notify backend first, before clearing store (access token still available)
          try {
            await apiService.notifyAuthEvent("SIGNED_OUT");
          } catch (error) {
            console.warn("Failed to notify backend about sign out:", error);
            // Continue with local sign out even if backend notification fails
          }

          store.user = null;
          store.currentView = "auth";
          toastService.show("Signed out successfully", "info");
        },

        async _handleTokenRefreshed(session, store) {
          // console.log("Token refreshed");
          store.user = session.user;

          // Notify backend
          await apiService.notifyAuthEvent("TOKEN_REFRESHED", {
            session: {
              user: session.user,
              access_token: session.access_token
            }
          });
        },

        async _handleUserUpdated(session, store) {
          // console.log("User updated");
          store.user = session.user;

          // Notify backend
          await apiService.notifyAuthEvent("USER_UPDATED", {
            session: {
              user: session.user,
              access_token: session.access_token
            }
          });
        },

        async _handlePasswordRecovery() {
          // console.log("Password recovery event");
          await apiService.notifyAuthEvent("PASSWORD_RECOVERY");
        },

        async _handleInitialSession() {
          // console.log("Initial session event");
          await apiService.notifyAuthEvent("INITIAL_SESSION");
        },

        async checkSession() {
          const supabase = Alpine.store("app").supabase;
          if (!supabase) return false;

          try {
            const {
              data: { session },
              error
            } = await supabase.auth.getSession();
            if (error) throw error;

            if (session?.user) {
              Alpine.store("app").user = session.user;
              return true;
            }
            return false;
          } catch (error) {
            console.error("Session check failed:", error);
            toastService.show(
              `Session check failed: ${error.message}`,
              "error"
            );
            return false;
          }
        }
      };

      const toastService = {
        show(message, type = "info") {
          const config = TOAST_TYPES[type] || TOAST_TYPES.info;
          const store = Alpine.store("toast");

          store.show = true;
          store.message = message;
          store.class = config.class;
          store.icon = config.icon;

          // Auto-hide
          setTimeout(() => {
            store.show = false;
          }, APP_CONFIG.TOAST_DURATION);

          // Refresh icons
          this.refreshIcons();
        },

        refreshIcons() {
          requestAnimationFrame(() => {
            if (typeof lucide !== "undefined" && lucide.createIcons) {
              lucide.createIcons();
            }
          });
        }
      };

      // Main Application Component
      function devAdminApp() {
        return {
          initialized: false,

          async init() {
            if (this.initialized) {
              // console.log("Application already initialized, skipping...");
              return;
            }

            // console.log("Initializing Dev Admin Dashboard...");
            this.initialized = true;

            try {
              await this.loadConfiguration();
              await this.initializeServices();
              await this.checkAuthentication();

              // console.log("Application initialization completed");
            } catch (error) {
              console.error("Initialization failed:", error);
              this.initialized = false; // Reset on failure
              toastService.show(
                `Initialization failed: ${error.message}`,
                "error"
              );
              Alpine.store("app").currentView = "auth";
            }
          },

          async loadConfiguration() {
            Alpine.store("app").loadingMessage = "Loading configuration...";

            try {
              const config = await utils.retry(() => configService.load());
              Alpine.store("app").config = config;
              // console.log("Configuration loaded successfully");
            } catch (error) {
              console.warn("Using fallback configuration:", error.message);
              Alpine.store("app").config = configService.getFallbackConfig();
              toastService.show("Using default configuration", "warning");
            }
          },

           async initializeServices() {
             const config = Alpine.store("app").config;
             Alpine.store("app").loadingMessage = "Setting up services...";

             // Initialize Sentry (async to handle script loading)
             if (config.sentryEnabled && config.sentryDsn) {
               await this.initSentryAsync(config);
             }

             // Initialize Supabase
             if (config.supabaseUrl && config.supabaseKey) {
               try {
                 Alpine.store("app").supabase = await authService.initSupabase(
                   config
                 );
               } catch (error) {
                 console.error("Supabase initialization failed:", error);
                 throw error;
               }
             } else {
               toastService.show("Authentication not configured", "warning");
               Alpine.store("app").currentView = "auth";
               return;
             }
           },

          async checkAuthentication() {
            Alpine.store("app").loadingMessage = "Checking authentication...";

            const isAuthenticated = await authService.checkSession();

            Alpine.store("app").currentView = isAuthenticated ? "app" : "auth";
            if (isAuthenticated) {
              Alpine.store("app").currentPage = "dashboard";
            }
          },

           initSentryAsync(config) {
             if (!config.sentryDsn) return;

             // Event-driven Sentry initialization - no polling or timeouts needed
             const initializeSentry = () => {
               if (typeof Sentry === 'undefined') {
                 // Sentry object not available despite script load event
                 return;
               }

               try {
                 Sentry.init({
                   dsn: config.sentryDsn,
                   environment: config.sentryEnvironment,
                   tracesSampleRate:
                     config.sentryEnvironment === "production" ? 0.1 : 1.0,
                   beforeSend(event) {
                     // Filter out network errors and other noise
                     if (event.exception?.values?.[0]?.type === 'NetworkError') {
                       return null;
                     }
                     return event;
                   }
                 });
                 console.log("Sentry initialized successfully via event listener");
               } catch (error) {
                 console.error("Sentry initialization failed:", error);
               }
             };

             // Check if Sentry is already available (script loaded before this runs)
             if (window.sentryLoaded && typeof Sentry !== 'undefined') {
               initializeSentry();
               return;
             }

             // Check if script failed to load
             if (window.sentryLoadFailed) {
               // Sentry script failed to load
               return;
             }

             // Listen for the script load event
             window.addEventListener('sentryReady', initializeSentry, { once: true });

             // Fallback: if script is still loading after DOM ready, wait for it
             if (document.readyState === 'loading') {
               document.addEventListener('DOMContentLoaded', () => {
                 // Give it a moment for deferred scripts to execute
                 setTimeout(() => {
                   if (!window.sentryLoaded && !window.sentryLoadFailed) {
                     // Sentry script load status unknown after DOM ready
                   }
                 }, 100);
               });
             }
           }
        };
      }

      // Component Functions
      function toastManager() {
        return {
          // This component uses the global store
        };
      }

      function authComponent() {
        return {
          formData: { email: "", password: "" },
          formErrors: {},
          isSignUp: false,

          oauthProviders: [
            { id: "google", name: "Google", icon: "chrome" },
            { id: "github", name: "GitHub", icon: "github" }
          ],

          async signInWithOAuth(provider) {
            const supabase = Alpine.store("app").supabase;
            if (!supabase) {
              toastService.show("Authentication not configured", "warning");
              return;
            }

            console.log(`Attempting ${provider} OAuth login...`);
            Alpine.store("auth").loading = true;

            try {
              const { error } = await supabase.auth.signInWithOAuth({
                provider,
                options: { redirectTo: window.location.href }
              });
              if (error) throw error;
            } catch (error) {
              console.error(`${provider} login failed:`, error);
              toastService.show(
                `${provider} login failed: ${error.message}`,
                "error"
              );
            } finally {
              Alpine.store("auth").loading = false;
            }
          },

          async handleEmailSubmit() {
            this.clearErrors();

            if (!this.validateForm()) return;

            const supabase = Alpine.store("app").supabase;
            if (!supabase) {
              toastService.show("Authentication not configured", "warning");
              return;
            }

            Alpine.store("auth").loading = true;

            try {
              if (this.isSignUp) {
                await this.signUp(supabase);
              } else {
                await this.signIn(supabase);
              }
            } finally {
              Alpine.store("auth").loading = false;
            }
          },

          async signIn(supabase) {
            console.log("Attempting email login...");

            try {
              const { data, error } = await supabase.auth.signInWithPassword({
                email: this.formData.email,
                password: this.formData.password
              });

              if (error) throw error;

              // console.log("Email login successful:", data.user.email);
              this.clearForm();
            } catch (error) {
              console.error("Email login failed:", error);
              toastService.show(`Login failed: ${error.message}`, "error");
            }
          },

          async signUp(supabase) {
            // console.log("Attempting email signup...");

            try {
              const { error } = await supabase.auth.signUp({
                email: this.formData.email,
                password: this.formData.password
              });

              if (error) throw error;

              toastService.show(
                "Account created! Please check your email for verification.",
                "success"
              );
              this.clearForm();
            } catch (error) {
              console.error("Email signup failed:", error);
              toastService.show(`Sign up failed: ${error.message}`, "error");
            }
          },

          validateForm() {
            if (!this.formData.email) {
              this.formErrors.email = "Email is required";
              return false;
            }

            if (!this.formData.password) {
              this.formErrors.password = "Password is required";
              return false;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(this.formData.email)) {
              this.formErrors.email = "Invalid email format";
              return false;
            }

            return true;
          },

          toggleSignUp() {
            this.isSignUp = !this.isSignUp;
            this.clearErrors();
            toastService.refreshIcons();
          },

          clearForm() {
            this.formData = { email: "", password: "" };
            this.clearErrors();
          },

          clearErrors() {
            this.formErrors = {};
          }
        };
      }

      function themeToggle() {
        return {
          isDark: false,
          initialized: false,

          init() {
            if (this.initialized) {
              // console.log("Theme toggle already initialized, skipping...");
              return;
            }
            this.initialized = true;
            this.loadTheme();

            // Refresh icons after initialization
            toastService.refreshIcons();
          },

          toggle() {
            this.isDark = !this.isDark;
            this.saveTheme();
            this.applyTheme();

            // Refresh icons after theme change
            toastService.refreshIcons();
          },

          loadTheme() {
            try {
              const savedTheme =
                localStorage.getItem(APP_CONFIG.THEME_STORAGE_KEY) || "light";
              this.isDark = savedTheme === "dark";
              this.applyTheme();
            } catch (error) {
              console.warn("localStorage not available, using default theme");
              this.isDark = false;
              this.applyTheme();
            }
          },

          saveTheme() {
            try {
              const theme = this.isDark ? "dark" : "light";
              localStorage.setItem(APP_CONFIG.THEME_STORAGE_KEY, theme);
            } catch (error) {
              console.warn(
                "localStorage not available, theme preference not saved"
              );
            }
          },

          applyTheme() {
            const theme = this.isDark ? "dark" : "light";
            document.documentElement.setAttribute("data-theme", theme);

            // Force a repaint
            document.documentElement.style.display = "none";
            document.documentElement.offsetHeight; // Trigger reflow
            document.documentElement.style.display = "";
          }
        };
      }

      function userMenu() {
        return {
          menuItems: [
            { id: "dashboard", label: "Dashboard", icon: "layout-dashboard" },
            { id: "onboarding", label: "Onboarding", icon: "user-check" },
            { id: "profile", label: "Profile", icon: "user" },
            { id: "sys-health", label: "Sys Health", icon: "heart-pulse" },
            { id: "app-state", label: "App State", icon: "settings" },
            { id: "request-state", label: "Request State", icon: "send" }
          ],

          async selectMenuItem(item) {
            try {
              // Use centralized API service for page navigation
              const data = await apiService.getPage(item.id);

              // Update the page
              Alpine.store("app").currentPage = item.id;

              // Store page data for components to use, including the message
              Alpine.store("app").pageData = {
                ...(data.data || {}),
                message: data.message,
                status: data.status
              };
            } catch (error) {
              console.error(`Error loading ${item.id} page:`, error);
              toastService.show(`Error loading ${item.label} page`, "error");

              // Fallback to local navigation
              Alpine.store("app").currentPage = item.id;
              Alpine.store("app").pageData = {};
            }

            this.closeDropdown();
          },

          closeDropdown() {
            // Close dropdown immediately
            document.activeElement.blur();

            // Additional cleanup
            setTimeout(() => {
              const dropdownInputs = document.querySelectorAll(
                '.dropdown input[type="checkbox"]'
              );
              dropdownInputs.forEach(input => (input.checked = false));
            }, 10);
          },

          async signOut() {
            if (this.isSigningOut) {
              // console.log("Sign out already in progress...");
              return;
            }

            this.isSigningOut = true;
            // console.log("User signing out...");

            try {
              const supabase = Alpine.store("app").supabase;
              if (supabase) {
                // Capture current session before sign out (for backend notification)
                const {
                  data: { session }
                } = await supabase.auth.getSession();
                if (session?.access_token) {
                  // Store the access token temporarily for the SIGNED_OUT event
                  window.pendingSignOutToken = session.access_token;
                }

                // This will trigger the auth state change handler which will handle backend notification
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
              } else {
                // Fallback if no supabase
                Alpine.store("app").user = null;
                Alpine.store("app").currentView = "auth";
                toastService.show("Signed out successfully", "info");
              }
            } catch (error) {
              console.error("Logout failed:", error);
              toastService.show(`Logout failed: ${error.message}`, "error");
            } finally {
              this.isSigningOut = false;
            }
          },

          isSigningOut: false,

          hasAvatar() {
            const user = Alpine.store("app").user;
            return user?.user_metadata?.avatar_url;
          },

          getAvatarUrl() {
            return utils.getUserAvatar(Alpine.store("app").user);
          },

          getInitials() {
            return utils.getUserInitials(Alpine.store("app").user);
          }
        };
      }

      function pageManager() {
        return {
          isTransitioning: false,
          initialized: false,

          init() {
            if (this.initialized) {
              // console.log("Page manager already initialized, skipping...");
              return;
            }
            this.initialized = true;

            this.$watch("$store.app.currentPage", () => {
              this.handlePageTransition();
            });
          },

          handlePageTransition() {
            this.isTransitioning = true;
            setTimeout(() => {
              this.isTransitioning = false;
              toastService.refreshIcons();
            }, 50);
          }
        };
      }

      function dashboardPage() {
        return {
          stats: [
            {
              id: "projects",
              label: "Total Projects",
              value: "12",
              icon: "folder",
              color: "primary"
            },
            {
              id: "tasks",
              label: "Active Tasks",
              value: "8",
              icon: "check-circle",
              color: "success"
            },
            {
              id: "issues",
              label: "Issues",
              value: "3",
              icon: "alert-circle",
              color: "warning"
            }
          ],

          getUserDisplayName() {
            return utils.getUserDisplayName(Alpine.store("app").user);
          }
        };
      }

      function profilePage() {
        return {
          personalFields: [],
          accountFields: [],
          initialized: false,

          init() {
            if (this.initialized) {
              // console.log("Profile page already initialized, skipping...");
              return;
            }
            this.initialized = true;

            this.updateFields();

            // Watch for page data changes
            this.$watch("$store.app.pageData", () => {
              this.updateFields();
            });
          },

          updateFields() {
            const user = Alpine.store("app").user;
            const pageData = Alpine.store("app").pageData;

            // Use backend profile data if available, fallback to user data
            const profileData = pageData || user;

            this.personalFields = [
              {
                id: "fullName",
                label: "Full Name",
                value:
                  profileData?.user_metadata?.full_name ||
                  profileData?.user_metadata?.name ||
                  profileData?.username ||
                  "Not provided"
              },
              {
                id: "email",
                label: "Email",
                value: profileData?.email || "Not provided",
                badge: profileData?.email_confirmed_at
                  ? { type: "success", text: "Verified" }
                  : { type: "warning", text: "Unverified" }
              },
              {
                id: "username",
                label: "Username",
                value: profileData?.username || "Not provided"
              }
            ];

            this.accountFields = [
              {
                id: "userId",
                label: "User ID",
                value: profileData?.id || "Unknown",
                mono: true
              },
              {
                id: "joined",
                label: "Joined",
                value: utils.formatDate(profileData?.created_at) || "Unknown"
              },
              {
                id: "lastSignIn",
                label: "Last Sign In",
                value:
                  utils.formatDate(profileData?.last_sign_in_at) || "Unknown"
              },
              {
                id: "provider",
                label: "Authentication Provider",
                value: profileData?.app_metadata?.provider || "email",
                icon: "shield-check"
              }
            ];
          },

          getUserDisplayName() {
            return utils.getUserDisplayName(Alpine.store("app").user);
          },

          getUserEmail() {
            return Alpine.store("app").user?.email || "";
          },

          getUserAvatarUrl() {
            return utils.getUserAvatar(Alpine.store("app").user);
          },

          getUserRoles() {
            const pageData = Alpine.store("app").pageData;
            const user = Alpine.store("app").user;

            // Use backend profile data if available, fallback to user data
            const profileData = pageData || user;

            // Return roles array, default to empty array if not available
            return profileData?.roles || [];
          },

          formatRole(role) {
            if (!role) return "";

            // Return role as-is without case conversion
            return role;
          }
        };
      }

      function appStatePage() {
        return {
          appStateData: null,
          loading: false,
          error: "",
          initialized: false,

          init() {
            if (this.initialized) {
              // console.log("App State page already initialized, skipping...");
              return;
            }
            this.initialized = true;

            // Watch for page data changes
            this.$watch("$store.app.pageData", newData => {
              this.updateAppStateData(newData);
            });

            // Initial data update
            this.updateAppStateData(Alpine.store("app").pageData);
          },

          updateAppStateData(pageData) {
            this.error = "";

            if (pageData && pageData.status === "success") {
              // Extract the actual app state data (everything except message and status)
              const { message, status, ...appStateData } = pageData;
              this.appStateData = appStateData;
            } else if (pageData && pageData.status === "http error") {
              this.error =
                pageData.message || "Failed to load app state data";
              this.appStateData = null;
            } else {
              this.appStateData = null;
            }
          },

          async loadHealthData() {
            if (this.loading) return;

            this.loading = true;
            this.error = "";

            try {
              const data = await apiService.call("/dev/app_state");

              // Update the store
              Alpine.store("app").pageData = {
                message: data.message,
                status: data.status,
                ...data.data
              };

              toastService.show("App state refreshed successfully", "success");
            } catch (error) {
              console.error("Error refreshing app state:", error);
              this.error =
                error.message || "Failed to refresh app state data";
              toastService.show("Failed to refresh app state", "error");
            } finally {
              this.loading = false;
            }
          },

          getPageTitle() {
            const pageData = Alpine.store("app").pageData;
            return pageData?.message || "Application State";
          },

          getPageDescription() {
            return "Real-time application state and configuration data";
          },

          formatAppStateData() {
            if (!this.appStateData) return "";
            try {
              return JSON.stringify(this.appStateData, null, 2);
            } catch (e) {
              return "Error formatting data";
            }
          },

          formatAppStateDataWithSyntax() {
            if (!this.appStateData) return "";
            try {
              const jsonString = JSON.stringify(this.appStateData, null, 2);
              // Simple syntax highlighting for JSON
              return jsonString
                .replace(
                  /("["\w_-]+")\s*:/g,
                  '<span class="text-purple-400">$1</span>:'
                )
                .replace(
                  /:\s*("[^"]*")/g,
                  ': <span class="text-green-400">$1</span>'
                )
                .replace(
                  /:\s*(\d+)/g,
                  ': <span class="text-blue-400">$1</span>'
                )
                .replace(
                  /:\s*(true|false)/g,
                  ': <span class="text-orange-400">$1</span>'
                )
                .replace(
                  /:\s*(null)/g,
                  ': <span class="text-gray-400">$1</span>'
                );
            } catch (e) {
              return '<span class="text-red-400">Error formatting data</span>';
            }
          },

          getLineNumbers() {
            if (!this.appStateData) return [];
            try {
              const lines = JSON.stringify(this.appStateData, null, 2).split(
                "\n"
              );
              return lines.map((_, index) => index + 1);
            } catch (e) {
              return [1];
            }
          },

          formatTimestamp() {
            const now = new Date();
            return now.toLocaleString("en-US", {
              month: "short",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          },

          getDataSize() {
            if (!this.appStateData) return "0 bytes";
            try {
              const jsonString = JSON.stringify(this.appStateData);
              const bytes = new Blob([jsonString]).size;
              if (bytes < 1024) return `${bytes} bytes`;
              if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
              return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            } catch (e) {
              return "0 bytes";
            }
          },

          getObjectCount() {
            if (!this.appStateData) return 0;
            try {
              const jsonString = JSON.stringify(this.appStateData);
              const braceCount = (jsonString.match(/\{/g) || []).length;
              const arrayCount = (jsonString.match(/\[/g) || []).length;
              return braceCount + arrayCount;
            } catch (e) {
              return 0;
            }
          },

          async exportAsJSON() {
            if (!this.appStateData) {
              toastService.show("No data to export", "warning");
              return;
            }

            try {
              const jsonString = JSON.stringify(this.appStateData, null, 2);
              const blob = new Blob([jsonString], { type: "application/json" });
              const url = URL.createObjectURL(blob);

              const a = document.createElement("a");
              a.href = url;
              a.download = `app-state-${
                new Date().toISOString().split("T")[0]
              }.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              toastService.show("File downloaded successfully", "success");
            } catch (error) {
              console.error("Export failed:", error);
              toastService.show("Export failed", "error");
            }
          },

          async copyToClipboard() {
            if (!this.appStateData) {
              toastService.show("No data to copy", "warning");
              return;
            }

            try {
              const jsonString = JSON.stringify(this.appStateData, null, 2);
              await navigator.clipboard.writeText(jsonString);
              toastService.show("Copied to clipboard", "success");
            } catch (error) {
              console.error("Copy failed:", error);
              toastService.show("Copy failed", "error");
            }
          }
        };
      }

      function requestStatePage() {
        return {
          requestStateData: null,
          loading: false,
          error: "",
          initialized: false,

          init() {
            if (this.initialized) {
              // console.log("Request State page already initialized, skipping...");
              return;
            }
            this.initialized = true;

            // Watch for page data changes
            this.$watch("$store.app.pageData", newData => {
              this.updateRequestStateData(newData);
            });

            // Initial data update
            this.updateRequestStateData(Alpine.store("app").pageData);
          },

          updateRequestStateData(pageData) {
            this.error = "";

            if (pageData && pageData.status === "success") {
              // Extract the actual request state data (everything except message and status)
              const { message, status, ...requestStateData } = pageData;
              this.requestStateData = requestStateData;
            } else if (pageData && pageData.status === "http error") {
              this.error =
                pageData.message || "Failed to load request state data";
              this.requestStateData = null;
            } else {
              this.requestStateData = null;
            }
          },

          async loadHealthData() {
            if (this.loading) return;

            this.loading = true;
            this.error = "";

            try {
              const data = await apiService.call("/dev/request_state");

              // Update the store
              Alpine.store("app").pageData = {
                message: data.message,
                status: data.status,
                ...data.data
              };

              toastService.show(
                "Request state refreshed successfully",
                "success"
              );
            } catch (error) {
              console.error("Error refreshing request state:", error);
              this.error =
                error.message || "Failed to refresh request state data";
              toastService.show("Failed to refresh request state", "error");
            } finally {
              this.loading = false;
            }
          },

          getPageTitle() {
            const pageData = Alpine.store("app").pageData;
            return pageData?.message || "Request State";
          },

          getPageDescription() {
            return "Real-time request state and processing data";
          },

          formatRequestStateData() {
            if (!this.requestStateData) return "";
            try {
              return JSON.stringify(this.requestStateData, null, 2);
            } catch (e) {
              return "Error formatting data";
            }
          },

          formatRequestStateDataWithSyntax() {
            if (!this.requestStateData) return "";
            try {
              const jsonString = JSON.stringify(this.requestStateData, null, 2);
              // Simple syntax highlighting for JSON
              return jsonString
                .replace(
                  /("["\w_-]+")\s*:/g,
                  '<span class="text-purple-400">$1</span>:'
                )
                .replace(
                  /:\s*("[^"]*")/g,
                  ': <span class="text-green-400">$1</span>'
                )
                .replace(
                  /:\s*(\d+)/g,
                  ': <span class="text-blue-400">$1</span>'
                )
                .replace(
                  /:\s*(true|false)/g,
                  ': <span class="text-orange-400">$1</span>'
                )
                .replace(
                  /:\s*(null)/g,
                  ': <span class="text-gray-400">$1</span>'
                );
            } catch (e) {
              return '<span class="text-red-400">Error formatting data</span>';
            }
          },

          getLineNumbers() {
            if (!this.requestStateData) return [];
            try {
              const lines = JSON.stringify(
                this.requestStateData,
                null,
                2
              ).split("\n");
              return lines.map((_, index) => index + 1);
            } catch (e) {
              return [1];
            }
          },

          formatTimestamp() {
            const now = new Date();
            return now.toLocaleString("en-US", {
              month: "short",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
              second: "2-digit"
            });
          },

          getDataSize() {
            if (!this.requestStateData) return "0 bytes";
            try {
              const jsonString = JSON.stringify(this.requestStateData);
              const bytes = new Blob([jsonString]).size;
              if (bytes < 1024) return `${bytes} bytes`;
              if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
              return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
            } catch (e) {
              return "0 bytes";
            }
          },

          getObjectCount() {
            if (!this.requestStateData) return 0;
            try {
              const jsonString = JSON.stringify(this.requestStateData);
              const braceCount = (jsonString.match(/\{/g) || []).length;
              const arrayCount = (jsonString.match(/\[/g) || []).length;
              return braceCount + arrayCount;
            } catch (e) {
              return 0;
            }
          },

          async exportAsJSON() {
            if (!this.requestStateData) {
              toastService.show("No data to export", "warning");
              return;
            }

            try {
              const jsonString = JSON.stringify(this.requestStateData, null, 2);
              const blob = new Blob([jsonString], { type: "application/json" });
              const url = URL.createObjectURL(blob);

              const a = document.createElement("a");
              a.href = url;
              a.download = `request-state-${
                new Date().toISOString().split("T")[0]
              }.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              toastService.show("File downloaded successfully", "success");
            } catch (error) {
              console.error("Export failed:", error);
              toastService.show("Export failed", "error");
            }
          },

          async copyToClipboard() {
            if (!this.requestStateData) {
              toastService.show("No data to copy", "warning");
              return;
            }

            try {
              const jsonString = JSON.stringify(this.requestStateData, null, 2);
              await navigator.clipboard.writeText(jsonString);
              toastService.show("Copied to clipboard", "success");
            } catch (error) {
              console.error("Copy failed:", error);
              toastService.show("Copy failed", "error");
            }
          }
        };
      }

      function sysHealthPage() {
        return {
          loading: false,
          error: null,
          healthData: null,
          lastUpdate: null,
          initialized: false,

          init() {
            if (this.initialized) {
              return;
            }
            this.initialized = true;

            // Load health data when page becomes active
            this.$watch("$store.app.currentPage", page => {
              if (page === "sys-health") {
                this.loadHealthData();
              }
            });

            // Initial load if we're already on this page
            if (Alpine.store("app").currentPage === "sys-health") {
              this.loadHealthData();
            }
          },

          async loadHealthData() {
            this.loading = true;
            this.error = null;

            try {
              const response = await fetch("/health");

              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }

              const data = await response.json();
              this.healthData = data.data || {};
              this.lastUpdate = new Date();
            } catch (err) {
              console.error("Failed to load health data:", err);
              this.error = err.message || "Failed to load health data";
            } finally {
              this.loading = false;
            }
          },

          getPluginIcon(pluginName) {
            const iconMap = {
              db: "database",
              redis: "cpu",
              sentry: "bug",
              auth: "shield"
            };
            return iconMap[pluginName] || "cog";
          },

          getPluginStatus(plugin) {
            if (!plugin || typeof plugin !== "object") {
              return { status: "unknown", color: "gray" };
            }

            // Check common status indicators
            if (plugin.status === "healthy" || plugin.healthy === true) {
              return { status: "healthy", color: "green" };
            }

            if (plugin.status === "error" || plugin.error || plugin.healthy === false) {
              return { status: "error", color: "red" };
            }

            if (plugin.status === "warning" || plugin.warnings) {
              return { status: "warning", color: "yellow" };
            }

            // For plugins with connection info, check if they're connected
            if (plugin.connected === true) {
              return { status: "healthy", color: "green" };
            }

            if (plugin.connected === false) {
              return { status: "error", color: "red" };
            }

            // Default to healthy if we have data
            return { status: "healthy", color: "green" };
          },

          formatPluginData(plugin) {
            if (!plugin || typeof plugin !== "object") {
              return [{ key: "Status", value: "No data available" }];
            }

            const formatted = [];

            // Add common fields first
            if (plugin.status) {
              formatted.push({ key: "Status", value: plugin.status });
            }

            if (plugin.connected !== undefined) {
              formatted.push({ key: "Connected", value: plugin.connected ? "Yes" : "No" });
            }

            // Add all other fields, excluding some internal ones
            Object.entries(plugin).forEach(([key, value]) => {
              if (!["status", "connected", "healthy"].includes(key)) {
                let displayValue = value;

                // Format different types of values
                if (typeof value === "boolean") {
                  displayValue = value ? "Yes" : "No";
                } else if (typeof value === "number") {
                  displayValue = value.toLocaleString();
                } else if (value && typeof value === "object") {
                  displayValue = JSON.stringify(value, null, 2);
                } else if (value === null || value === undefined) {
                  displayValue = "N/A";
                }

                formatted.push({
                  key: key.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase()),
                  value: displayValue
                });
              }
            });

            return formatted.length > 0 ? formatted : [{ key: "Status", value: "Available" }];
          },

          formatLastUpdate() {
            if (!this.lastUpdate) return "Never";

            const now = new Date();
            const diffMs = now - this.lastUpdate;
            const diffSecs = Math.floor(diffMs / 1000);

            if (diffSecs < 60) {
              return `${diffSecs} seconds ago`;
            } else if (diffSecs < 3600) {
              return `${Math.floor(diffSecs / 60)} minutes ago`;
            } else {
              return this.lastUpdate.toLocaleTimeString();
            }
          }
        };
      }

      function onboardingPage() {
        return {
          progressSteps: [
            { id: "profile", label: "Profile Setup", progress: 100 },
            { id: "auth", label: "Authentication", progress: 100 },
            { id: "dashboard", label: "Dashboard Exploration", progress: 25 }
          ],
          initialized: false,
          headlineMessage: "",

          init() {
            if (this.initialized) {
              // console.log("Onboarding page already initialized, skipping...");
              return;
            }
            this.initialized = true;

            // Update headline when page data changes
            this.$watch("$store.app.pageData", newData => {
              this.updateHeadlineMessage();
            });

            this.$watch("$store.app.currentPage", page => {
              // Update dashboard exploration progress
              const dashboardStep = this.progressSteps.find(
                s => s.id === "dashboard"
              );
              if (dashboardStep) {
                dashboardStep.progress = page === "dashboard" ? 100 : 25;
              }

              // Update headline when switching to onboarding page
              if (page === "onboarding") {
                this.updateHeadlineMessage();
              }
            });

            // Initial headline update
            this.updateHeadlineMessage();
          },

          updateHeadlineMessage() {
            const pageData = Alpine.store("app").pageData;
            if (pageData && pageData.message) {
              this.headlineMessage = pageData.message;
            } else {
              this.headlineMessage = "";
            }
          },

          getHeadlineMessage() {
            return this.headlineMessage || "";
          },

          getUserDisplayName() {
            return utils.getUserDisplayName(Alpine.store("app").user);
          }
        };
      }

      // Global Error Handling
      window.addEventListener("error", e => {
        console.error("Global error:", e.error);
        if (typeof Sentry !== "undefined") {
          Sentry.captureException(e.error);
        }
      });

      window.addEventListener("unhandledrejection", e => {
        console.error("Unhandled promise rejection:", e.reason);
        if (typeof Sentry !== "undefined") {
          Sentry.captureException(e.reason);
        }
        e.preventDefault();
      });

      // Initialize icons when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        // console.log("Page loaded");
        toastService.refreshIcons();
      });
    </script>

    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </body>
</html>
